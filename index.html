<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام مطعم حكاية | Hekaya POS</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f8fafc;
            height: 100vh;
            overflow: hidden;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* UI Utilities */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .category-btn.active {
            background: linear-gradient(135deg, #0284c7 0%, #0ea5e9 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.3);
            transform: translateY(-1px);
        }

        .item-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: #38bdf8;
        }

        /* Modal Animation */
        .modal-enter { animation: modalIn 0.3s ease-out forwards; }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10B981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10B981;
        }

        /* Loading Spinner */
        .ai-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Print Styles */
        @media print {
            @page { size: auto; margin: 0; }
            body { background: white; margin: 0; }
            body > * { display: none !important; }
            #print-area {
                display: block !important;
                position: absolute;
                left: 0; top: 0; width: 100%;
                background: white; direction: rtl;
            }
            #print-area * { visibility: visible; }
        }
    </style>
</head>
<body class="flex flex-col h-screen text-slate-800">

    <!-- ================= LOGIN SCREEN ================= -->
    <div id="login-screen" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md border-4 border-slate-800 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-sky-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 -translate-y-1/2 translate-x-1/2"></div>
            <div class="absolute bottom-0 left-0 w-32 h-32 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 translate-y-1/2 -translate-x-1/2"></div>
            
            <div class="text-center mb-8 relative z-10">
                <div class="w-20 h-20 bg-gradient-to-br from-sky-500 to-blue-700 rounded-2xl flex items-center justify-center shadow-lg mx-auto mb-4 transform rotate-3">
                    <i class="fas fa-fish text-4xl text-white"></i>
                </div>
                <h1 class="text-3xl font-black text-slate-800">مطعم حكاية</h1>
                <p class="text-slate-500">نظام إدارة المطاعم الذكي</p>
            </div>

            <form onsubmit="handleLogin(event)" class="space-y-5 relative z-10">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">البريد الإلكتروني</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <i class="fas fa-envelope text-slate-400"></i>
                        </div>
                        <input type="email" id="login-email" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block w-full pr-10 p-2.5" placeholder="name@hekaya.com" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">كلمة المرور</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <i class="fas fa-lock text-slate-400"></i>
                        </div>
                        <input type="password" id="login-password" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block w-full pr-10 p-2.5" placeholder="••••••••" required>
                    </div>
                </div>
                <button type="submit" class="w-full text-white bg-gradient-to-r from-sky-500 to-blue-600 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-blue-300 font-bold rounded-lg text-sm px-5 py-3 text-center shadow-lg transform transition hover:-translate-y-1">
                    تسجيل الدخول
                </button>
            </form>
            <div id="login-error" class="mt-4 text-center text-red-500 text-sm font-bold hidden">
                بيانات الدخول غير صحيحة!
            </div>
        </div>
    </div>

    <!-- ================= MAIN APP LAYOUT (Hidden initially) ================= -->
    <div id="main-app" class="flex flex-col h-screen hidden">
        <!-- Top Navigation -->
        <nav class="bg-slate-900 text-white p-3 shadow-xl z-50 relative">
            <div class="container mx-auto flex justify-between items-center relative z-10">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-gradient-to-br from-sky-400 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-fish text-xl text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-black tracking-tight">مطعم حكاية</h1>
                        <p class="text-[10px] text-sky-200 font-medium" id="user-display-name">مرحباً، المستخدم</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <div class="bg-slate-800/80 p-1 rounded-xl flex shadow-inner border border-slate-700/50 overflow-x-auto gap-1">
                        <button onclick="switchView('waiter')" id="btn-waiter" class="nav-btn hidden flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700/50">
                            <i class="fas fa-tablet-alt"></i> النادل
                        </button>
                        <button onclick="switchView('system')" id="btn-system" class="nav-btn hidden flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700/50">
                            <i class="fas fa-desktop"></i> الكاشير
                        </button>
                        <button onclick="switchView('delivery')" id="btn-delivery" class="nav-btn hidden flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700/50">
                            <i class="fas fa-motorcycle"></i> الدليفري
                        </button>
                        <button onclick="switchView('transactions')" id="btn-transactions" class="nav-btn hidden flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700/50">
                            <i class="fas fa-file-invoice"></i> الفواتير
                        </button>
                        <button onclick="switchView('reports')" id="btn-reports" class="nav-btn hidden flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700/50">
                            <i class="fas fa-chart-pie"></i> التقارير
                        </button>
                        <button onclick="switchView('inventory')" id="btn-inventory" class="nav-btn hidden flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700/50">
                            <i class="fas fa-boxes"></i> المخزون
                        </button>
                        <button onclick="switchView('expenses')" id="btn-expenses" class="nav-btn hidden flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700/50">
                            <i class="fas fa-wallet"></i> المصروفات
                        </button>
                        <button onclick="switchView('settings')" id="btn-settings" class="nav-btn hidden flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700/50">
                            <i class="fas fa-cog"></i> الإعدادات
                        </button>
                        <button onclick="switchView('admin')" id="btn-admin" class="nav-btn hidden flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700/50 border-r border-slate-600 mr-2 pr-2">
                            <i class="fas fa-database"></i> البيانات
                        </button>
                    </div>
                    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg text-xs font-bold transition ml-2 shadow-md">
                        <i class="fas fa-sign-out-alt"></i> خروج
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 overflow-hidden relative">

            <!-- WAITER VIEW -->
            <div id="waiter-view" class="view-section absolute inset-0 flex flex-col transition-all duration-300 hidden">
                <!-- Header -->
                <div class="bg-white/80 backdrop-blur-md border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm z-20">
                    <div class="flex items-center gap-4 bg-slate-100 rounded-lg p-1 pr-4 border border-slate-200">
                        <span class="text-slate-500 font-bold text-sm"><i class="fas fa-chair text-slate-400 ml-2"></i>نوع الطلب:</span>
                        <select id="order-type-select" class="bg-white border-0 text-slate-800 text-sm font-bold rounded-md focus:ring-2 focus:ring-sky-500 block w-40 py-2" onchange="toggleDeliveryFields()">
                            <option value="dine-in">محلي (طاولة)</option>
                            <option value="delivery">دليفري (توصيل)</option>
                        </select>
                    </div>
                    <div id="table-select-wrapper" class="flex items-center gap-2">
                        <span class="text-slate-500 font-bold text-sm">رقم الطاولة:</span>
                        <select id="table-select" class="bg-white border border-slate-300 text-slate-800 text-sm font-bold rounded-md py-1 px-2"></select>
                    </div>
                    <div id="delivery-fields" class="hidden flex items-center gap-2">
                        <input type="text" id="cust-name" placeholder="اسم العميل" class="bg-white border border-slate-300 rounded px-2 py-1 text-sm w-32">
                        <input type="text" id="cust-phone" placeholder="رقم الهاتف" class="bg-white border border-slate-300 rounded px-2 py-1 text-sm w-32">
                        <input type="text" id="cust-address" placeholder="العنوان" class="bg-white border border-slate-300 rounded px-2 py-1 text-sm w-48">
                    </div>
                    <div class="flex items-center gap-2 bg-sky-50 text-sky-700 px-4 py-2 rounded-lg border border-sky-100">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="font-bold text-sm">متصل</span>
                    </div>
                </div>
                <div class="flex flex-1 overflow-hidden">
                    <!-- Menu -->
                    <div class="flex-1 flex flex-col relative">
                        <div class="p-4 bg-white/50 border-b border-slate-200 flex gap-3 overflow-x-auto scrollbar-hide">
                            <button onclick="filterMenu('all')" class="category-btn active px-6 py-3 rounded-xl font-bold bg-white border border-slate-200 shadow-sm">الكل</button>
                            <button onclick="filterMenu('fish')" class="category-btn px-6 py-3 rounded-xl font-bold bg-white border border-slate-200 shadow-sm">أسماك</button>
                            <button onclick="filterMenu('shrimp')" class="category-btn px-6 py-3 rounded-xl font-bold bg-white border border-slate-200 shadow-sm">جمبري</button>
                            <button onclick="filterMenu('sides')" class="category-btn px-6 py-3 rounded-xl font-bold bg-white border border-slate-200 shadow-sm">جانبي</button>
                            <button onclick="filterMenu('drinks')" class="category-btn px-6 py-3 rounded-xl font-bold bg-white border border-slate-200 shadow-sm">مشروبات</button>
                        </div>
                        <div id="menu-grid" class="p-6 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-5 overflow-y-auto pb-24"></div>
                    </div>
                    <!-- Cart -->
                    <div class="w-96 bg-white/95 backdrop-blur shadow-2xl z-30 flex flex-col border-r border-slate-200">
                        <div class="p-5 bg-gradient-to-l from-slate-50 to-white border-b border-slate-100">
                            <h2 class="font-extrabold text-xl text-slate-800 flex items-center gap-2">
                                <i class="fas fa-receipt text-sky-500"></i> الطلب الحالي
                            </h2>
                        </div>
                        <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/50"></div>
                        <div class="px-5 pt-2">
                            <button onclick="getSmartSuggestions()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-600 text-white font-bold py-2 rounded-lg shadow-md hover:from-violet-600 hover:to-fuchsia-700 transition flex items-center justify-center gap-2 text-sm border border-fuchsia-400/50">
                                <i class="fas fa-sparkles text-yellow-300"></i> اقتراحات ذكية (AI)
                            </button>
                        </div>
                        <div class="p-5 bg-white border-t border-slate-200">
                            <div class="flex justify-between items-center mb-6 text-xl font-black text-slate-800">
                                <span>الإجمالي التقديري:</span>
                                <span id="cart-total" class="text-sky-600">0.00 ر.س</span>
                            </div>
                            <button onclick="submitOrder()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg transition flex justify-center items-center gap-3">
                                <span>إرسال للمطبخ</span> <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SYSTEM VIEW -->
            <div id="system-view" class="view-section absolute inset-0 flex flex-col bg-slate-100/50 hidden opacity-0 transition-opacity duration-300">
                <div class="p-6 flex-1 overflow-y-auto">
                    <div class="flex justify-between items-end mb-8">
                        <h2 class="text-3xl font-black text-slate-800">شاشة الكاشير والمطبخ (محلي)</h2>
                        <div class="flex gap-4">
                            <div class="bg-white px-6 py-3 rounded-xl shadow-sm border border-slate-200 text-center">
                                <span class="text-xs font-bold text-slate-400">المبيعات</span>
                                <span id="stats-revenue" class="block font-black text-2xl text-emerald-600">0 ر.س</span>
                            </div>
                        </div>
                    </div>
                    <div id="no-orders-msg" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
                        <i class="fas fa-clipboard-list text-5xl mb-4 text-slate-200"></i>
                        <h3>لا توجد طلبات نشطة</h3>
                    </div>
                    <div id="orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 relative z-10"></div>
                </div>
            </div>

            <!-- DELIVERY VIEW -->
            <div id="delivery-view" class="view-section absolute inset-0 flex flex-col bg-slate-100/50 hidden opacity-0 transition-opacity duration-300">
                <div class="p-6 flex-1 overflow-y-auto">
                    <h2 class="text-3xl font-black text-slate-800 mb-6"><i class="fas fa-motorcycle text-orange-500 ml-2"></i>إدارة طلبات الدليفري</h2>
                    <div class="grid grid-cols-3 gap-6 h-[80vh]">
                        <div class="bg-white rounded-2xl shadow p-4 flex flex-col"><h3 class="font-bold text-lg mb-4 text-slate-700 border-b pb-2">جاري التحضير <span id="count-prep" class="bg-slate-200 px-2 rounded-full text-xs">0</span></h3><div id="delivery-prep" class="flex-1 overflow-y-auto space-y-3"></div></div>
                        <div class="bg-white rounded-2xl shadow p-4 flex flex-col"><h3 class="font-bold text-lg mb-4 text-orange-600 border-b pb-2">خرج للتوصيل <span id="count-out" class="bg-orange-100 px-2 rounded-full text-xs">0</span></h3><div id="delivery-out" class="flex-1 overflow-y-auto space-y-3"></div></div>
                        <div class="bg-white rounded-2xl shadow p-4 flex flex-col"><h3 class="font-bold text-lg mb-4 text-green-600 border-b pb-2">تم التسليم <span id="count-done" class="bg-green-100 px-2 rounded-full text-xs">0</span></h3><div id="delivery-done" class="flex-1 overflow-y-auto space-y-3"></div></div>
                    </div>
                </div>
            </div>

            <!-- TRANSACTIONS VIEW -->
            <div id="transactions-view" class="view-section absolute inset-0 flex flex-col bg-slate-100/50 hidden opacity-0 transition-opacity duration-300">
                <div class="p-8 max-w-6xl mx-auto w-full h-full overflow-y-auto">
                    <h2 class="text-3xl font-black text-slate-800 mb-6"><i class="fas fa-history text-slate-500 ml-2"></i>سجل الفواتير والمرتجعات</h2>
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                        <table class="w-full text-sm text-right text-slate-600">
                            <thead class="bg-slate-50 text-slate-700 uppercase font-bold"><tr><th class="px-6 py-4">رقم الفاتورة</th><th class="px-6 py-4">النوع / الطاولة</th><th class="px-6 py-4">الوقت</th><th class="px-6 py-4">الإجمالي</th><th class="px-6 py-4">الحالة</th><th class="px-6 py-4 text-center">إجراءات</th></tr></thead>
                            <tbody id="transactions-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- REPORTS VIEW -->
            <div id="reports-view" class="view-section absolute inset-0 flex flex-col bg-slate-100/50 hidden opacity-0 transition-opacity duration-300">
                <div class="p-8 max-w-6xl mx-auto w-full h-full overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-black text-slate-800"><i class="fas fa-chart-pie text-purple-500 ml-2"></i>التقارير المالية والتحليلات</h2>
                        <button onclick="renderReports()" class="bg-white border border-slate-300 text-slate-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-50"><i class="fas fa-sync-alt ml-2"></i>تحديث</button>
                    </div>
                    
                    <!-- Financial Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-2xl shadow border-r-4 border-emerald-500">
                            <p class="text-slate-500 font-bold text-xs uppercase">إجمالي المبيعات (الإيرادات)</p>
                            <p id="report-total-sales" class="text-2xl font-black text-emerald-600 mt-2">0 ر.س</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow border-r-4 border-blue-500">
                            <p class="text-slate-500 font-bold text-xs uppercase">تكلفة البضاعة المباعة (COGS)</p>
                            <p id="report-cogs" class="text-2xl font-black text-blue-600 mt-2">0 ر.س</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow border-r-4 border-red-500">
                            <p class="text-slate-500 font-bold text-xs uppercase">إجمالي المصروفات التشغيلية</p>
                            <p id="report-expenses" class="text-2xl font-black text-red-600 mt-2">0 ر.س</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow border-r-4 border-purple-600">
                            <p class="text-slate-500 font-bold text-xs uppercase">صافي الأرباح / الخسائر</p>
                            <p id="report-net-profit" class="text-2xl font-black text-purple-700 mt-2">0 ر.س</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-2xl shadow">
                            <h3 class="font-bold text-lg mb-6 text-slate-800 border-b pb-2">تحليل المبيعات حسب الفئة</h3>
                            <div class="space-y-6" id="category-bars"></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow">
                            <h3 class="font-bold text-lg mb-6 text-slate-800 border-b pb-2">ملخص العمليات</h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center"><span class="text-slate-600 font-bold">عدد الطلبات المكتملة</span><span id="report-total-orders" class="font-black text-slate-800">0</span></div>
                                <div class="flex justify-between items-center"><span class="text-slate-600 font-bold">الفواتير الملغاة</span><span id="report-cancelled" class="font-black text-red-500">0</span></div>
                                <div class="flex justify-between items-center"><span class="text-slate-600 font-bold">أكثر صنف مبيعاً</span><span id="report-top-item" class="font-black text-sky-600">-</span></div>
                                <div class="flex justify-between items-center"><span class="text-slate-600 font-bold">قيمة المخزون الحالي</span><span id="report-stock-value" class="font-black text-slate-800">0 ر.س</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INVENTORY VIEW -->
            <div id="inventory-view" class="view-section absolute inset-0 flex flex-col bg-slate-100/50 hidden opacity-0 transition-opacity duration-300">
                <div class="p-8 max-w-6xl mx-auto w-full h-full overflow-y-auto">
                    <div class="flex gap-4 mb-6 border-b pb-2">
                        <button onclick="switchInventoryTab('stock')" id="tab-inv-stock" class="inv-tab-btn px-4 py-2 font-bold text-sky-600 border-b-2 border-sky-600">حالة المخزون</button>
                        <button onclick="switchInventoryTab('purchases')" id="tab-inv-purchases" class="inv-tab-btn px-4 py-2 font-bold text-slate-500 hover:text-sky-600">سجل المشتريات</button>
                        <button onclick="switchInventoryTab('movements')" id="tab-inv-movements" class="inv-tab-btn px-4 py-2 font-bold text-slate-500 hover:text-sky-600">حركة المخزون</button>
                    </div>

                    <!-- Stock Tab -->
                    <div id="inv-content-stock">
                        <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-8">
                            <table class="w-full text-sm text-right text-slate-600">
                                <thead class="bg-slate-50 text-slate-700 uppercase font-bold"><tr><th class="px-6 py-4">الصنف</th><th class="px-6 py-4">الكمية الحالية</th><th class="px-6 py-4">سعر التكلفة</th><th class="px-6 py-4">سعر البيع</th><th class="px-6 py-4">القيمة الإجمالية</th><th class="px-6 py-4">الحالة</th><th class="px-6 py-4 text-center">تعديل</th></tr></thead>
                                <tbody id="inventory-stock-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Purchases Tab -->
                    <div id="inv-content-purchases" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-xl text-slate-800">فواتير المشتريات</h3>
                            <button onclick="openAddPurchaseModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg shadow-md font-bold flex items-center gap-2"><i class="fas fa-plus"></i> فاتورة شراء جديدة</button>
                        </div>
                        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                            <table class="w-full text-sm text-right text-slate-600">
                                <thead class="bg-slate-50 text-slate-700 uppercase font-bold"><tr><th class="px-6 py-4">رقم الفاتورة</th><th class="px-6 py-4">التاريخ</th><th class="px-6 py-4">المورد</th><th class="px-6 py-4">الإجمالي</th><th class="px-6 py-4">ملاحظات</th><th class="px-6 py-4">التفاصيل</th></tr></thead>
                                <tbody id="inventory-purchases-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Movements Tab -->
                    <div id="inv-content-movements" class="hidden">
                        <h3 class="font-bold text-xl text-slate-800 mb-6">سجل حركة المخزون</h3>
                        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                            <table class="w-full text-sm text-right text-slate-600">
                                <thead class="bg-slate-50 text-slate-700 uppercase font-bold"><tr><th class="px-6 py-4">التاريخ</th><th class="px-6 py-4">الصنف</th><th class="px-6 py-4">العملية</th><th class="px-6 py-4">الكمية</th><th class="px-6 py-4">المستخدم</th><th class="px-6 py-4">ملاحظات</th></tr></thead>
                                <tbody id="inventory-movements-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EXPENSES VIEW -->
            <div id="expenses-view" class="view-section absolute inset-0 flex flex-col bg-slate-100/50 hidden opacity-0 transition-opacity duration-300">
                <div class="p-8 max-w-6xl mx-auto w-full h-full overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-black text-slate-800"><i class="fas fa-wallet text-red-500 ml-2"></i>المصروفات التشغيلية</h2>
                        <button onclick="openAddExpenseModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-md font-bold flex items-center gap-2"><i class="fas fa-plus"></i> تسجيل مصروف</button>
                    </div>
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                        <table class="w-full text-sm text-right text-slate-600">
                            <thead class="bg-slate-50 text-slate-700 uppercase font-bold"><tr><th class="px-6 py-4">التاريخ</th><th class="px-6 py-4">البند / الفئة</th><th class="px-6 py-4">المبلغ</th><th class="px-6 py-4">الوصف</th><th class="px-6 py-4">المستخدم</th><th class="px-6 py-4 text-center">حذف</th></tr></thead>
                            <tbody id="expenses-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ADMIN VIEW (DATA CONTROL) -->
            <div id="admin-view" class="view-section absolute inset-0 flex flex-col bg-slate-100 hidden opacity-0 transition-opacity duration-300">
                <div class="p-8 max-w-6xl mx-auto w-full h-full overflow-y-auto">
                    <div class="flex justify-between items-center mb-8">
                        <div><h2 class="text-2xl font-black text-slate-800 mb-2">قائمة الأصناف</h2><p class="text-slate-500">إدارة الأصناف، المخزون، والأسعار.</p></div>
                        <div class="flex gap-2">
                            <button onclick="openAddItemModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg shadow-md font-bold flex items-center gap-2 transition"><i class="fas fa-plus-circle"></i> إضافة صنف</button>
                            <button onclick="generateMarketingPost()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow-md font-bold flex items-center gap-2 transition"><i class="fas fa-bullhorn"></i> ✨ توليد إعلان</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-8"><table class="w-full text-sm text-right text-slate-600"><thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b"><tr><th class="px-6 py-4">الصنف</th><th class="px-6 py-4">الفئة</th><th class="px-6 py-4">السعر (ر.س)</th><th class="px-6 py-4">التكلفة (ر.س)</th><th class="px-6 py-4">الحالة (Stock)</th><th class="px-6 py-4 text-center">تحديث</th></tr></thead><tbody id="admin-table-body"></tbody></table></div>
                </div>
            </div>

            <!-- SETTINGS VIEW -->
            <div id="settings-view" class="view-section absolute inset-0 flex flex-col bg-slate-100 hidden opacity-0 transition-opacity duration-300">
                <div class="p-8 max-w-6xl mx-auto w-full h-full overflow-y-auto">
                    <h2 class="text-3xl font-black text-slate-800 mb-6"><i class="fas fa-cog text-slate-500 ml-2"></i>الإعدادات والمستخدمين</h2>
                    
                    <!-- General Settings -->
                    <div class="bg-white rounded-2xl shadow-md p-6 mb-8">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2">إعدادات النظام</h3>
                        <div class="flex items-center justify-between">
                            <div><p class="font-bold text-slate-700">عدد الطاولات</p><p class="text-xs text-slate-500">عدد الطاولات المتاحة في صالة الطعام</p></div>
                            <div class="flex items-center gap-2"><input type="number" id="settings-table-count" class="w-20 border rounded p-2 text-center" min="1" max="100"><button onclick="saveTableSettings()" class="bg-sky-500 text-white px-4 py-2 rounded hover:bg-sky-600 font-bold text-sm">حفظ</button></div>
                        </div>
                    </div>

                    <!-- Subscription Settings -->
                    <div class="bg-white rounded-2xl shadow-md p-6 mb-8 border-r-4 border-purple-500">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2">حالة الاشتراك</h3>
                        <div class="flex items-center justify-between">
                            <div><p class="font-bold text-slate-700" id="sub-status-text">جاري التحقق...</p><p class="text-xs text-slate-500" id="sub-expiry-text">ينتهي في: -</p></div>
                            <div class="flex items-center gap-2"><input type="text" id="settings-sub-code" class="w-64 border rounded p-2 text-left text-xs font-mono" placeholder="أدخل كود التفعيل الجديد"><button onclick="updateSubscriptionFromSettings()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 font-bold text-sm">تجديد</button></div>
                        </div>
                    </div>

                    <!-- Users Management -->
                    <div class="bg-white rounded-2xl shadow-md p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div><h3 class="font-bold text-lg text-slate-800">إدارة المستخدمين</h3><p class="text-sm text-slate-500">إنشاء حسابات وتحديد الصلاحيات</p></div>
                            <button onclick="openAddUserModal()" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-lg shadow-md font-bold flex items-center gap-2 transition"><i class="fas fa-user-plus"></i> مستخدم جديد</button>
                        </div>
                        <table class="w-full text-sm text-right text-slate-600">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b">
                                <tr>
                                    <th class="px-6 py-4">الاسم</th>
                                    <th class="px-6 py-4">البريد الإلكتروني</th>
                                    <th class="px-6 py-4">الصلاحيات</th>
                                    <th class="px-6 py-4 text-center">حذف</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODALS (Keep existing ones, Add User Modal) -->
    <!-- Customization Modal -->
    <div id="custom-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] hidden flex items-center justify-center">
        <!-- (Same as before) -->
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="bg-slate-900 text-white p-4 flex justify-between items-center"><h3 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-utensils"></i> <span id="modal-item-name">تخصيص الصنف</span></h3><button onclick="closeModal('custom-modal')" class="text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button></div>
            <div class="p-6 space-y-6">
                <div><label class="block text-sm font-bold text-slate-700 mb-2" id="qty-label">الوزن</label><div class="flex items-center gap-2"><button onclick="adjustModalQty(-0.25)" class="w-10 h-10 bg-slate-100 rounded-lg font-bold">-</button><input type="number" id="modal-qty" class="flex-1 bg-slate-50 border rounded-lg p-2 text-center font-bold text-lg" value="1.0" step="0.1"><button onclick="adjustModalQty(0.25)" class="w-10 h-10 bg-slate-100 rounded-lg font-bold">+</button></div></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-2">طريقة الطهي</label><div class="grid grid-cols-2 gap-3" id="cooking-options"></div></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-2">ملاحظات</label><textarea id="modal-notes" class="w-full bg-slate-50 border rounded-lg p-2 text-sm" rows="2"></textarea></div>
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-end gap-3"><button onclick="closeModal('custom-modal')" class="px-4 py-2 font-bold rounded-lg hover:bg-slate-200">إلغاء</button><button onclick="confirmCustomization()" class="px-6 py-2 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700">إضافة</button></div>
        </div>
    </div>

    <!-- Add Item Modal (Same as before) -->
    <div id="add-item-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[65] hidden flex items-center justify-center">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="bg-emerald-600 text-white p-4 flex justify-between items-center"><h3 id="modal-item-title" class="font-bold text-lg">إضافة صنف</h3><button onclick="closeModal('add-item-modal')" class="text-white/80 hover:text-white"><i class="fas fa-times text-xl"></i></button></div>
            <div class="p-6 space-y-4">
                <div><label class="block text-sm font-bold text-slate-700 mb-1">الاسم</label><input type="text" id="new-item-name" class="w-full border rounded p-2"></div>
                <div class="grid grid-cols-3 gap-4"><div><label class="block text-sm font-bold text-slate-700 mb-1">السعر</label><input type="number" id="new-item-price" class="w-full border rounded p-2"></div><div><label class="block text-sm font-bold text-slate-700 mb-1">التكلفة</label><input type="number" id="new-item-cost" class="w-full border rounded p-2"></div><div><label class="block text-sm font-bold text-slate-700 mb-1">الوحدة</label><select id="new-item-type" class="w-full border rounded p-2"><option value="unit">عدد</option><option value="weight">وزن</option></select></div></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">الفئة</label><select id="new-item-category" class="w-full border rounded p-2"><option value="fish">أسماك</option><option value="shrimp">جمبري</option><option value="sides">جانبي</option><option value="drinks">مشروبات</option></select></div>
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-end gap-3"><button onclick="closeModal('add-item-modal')" class="px-4 py-2 font-bold hover:bg-slate-200 rounded-lg">إلغاء</button><button onclick="saveNewItem()" class="px-6 py-2 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700">حفظ</button></div>
        </div>
    </div>

    <!-- STOCK ADJUSTMENT MODAL -->
    <div id="stock-adjust-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[85] hidden flex items-center justify-center">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="bg-slate-800 text-white p-4 flex justify-between items-center"><h3 class="font-bold text-lg">تعديل المخزون</h3><button onclick="closeModal('stock-adjust-modal')" class="text-white/80 hover:text-white"><i class="fas fa-times text-xl"></i></button></div>
            <div class="p-6 space-y-4">
                <p class="font-bold text-slate-700" id="adjust-item-name"></p>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">الكمية (موجب إضافة / سالب خصم)</label><input type="number" id="adjust-qty" class="w-full border rounded p-2 text-center font-bold" placeholder="0"></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">سبب التعديل</label><select id="adjust-reason" class="w-full border rounded p-2"><option value="correction">تصحح جرد</option><option value="damage">تالف / هالك</option><option value="gift">ضيافة / هدية</option><option value="return">مرتجع</option><option value="other">أخرى</option></select></div>
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-end gap-3"><button onclick="closeModal('stock-adjust-modal')" class="px-4 py-2 font-bold hover:bg-slate-200 rounded-lg">إلغاء</button><button onclick="saveStockAdjustment()" class="px-6 py-2 bg-slate-800 text-white font-bold rounded-lg hover:bg-slate-900">حفظ التعديل</button></div>
        </div>
    </div>

    <!-- ADD USER MODAL -->
    <div id="add-user-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[75] hidden flex items-center justify-center">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="bg-slate-800 text-white p-4 flex justify-between items-center">
                <h3 id="modal-user-title" class="font-bold text-lg"><i class="fas fa-user-plus"></i> مستخدم جديد</h3>
                <button onclick="closeModal('add-user-modal')" class="text-white/80 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-bold text-slate-700 mb-1">الاسم</label><input type="text" id="new-user-name" class="w-full border rounded p-2"></div>
                    <div><label class="block text-sm font-bold text-slate-700 mb-1">كلمة المرور</label><input type="text" id="new-user-pass" class="w-full border rounded p-2"></div>
                </div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">البريد الإلكتروني</label><input type="email" id="new-user-email" class="w-full border rounded p-2"></div>
                
                <div class="border-t pt-4 mt-2">
                    <label class="block text-sm font-bold text-slate-700 mb-3">صلاحيات الوصول للصفحات:</label>
                    <div class="grid grid-cols-2 gap-3" id="permissions-list">
                        <label class="flex items-center space-x-2 space-x-reverse"><input type="checkbox" value="waiter" class="perm-check w-4 h-4 text-sky-600"> <span>تابلت النادل</span></label>
                        <label class="flex items-center space-x-2 space-x-reverse"><input type="checkbox" value="system" class="perm-check w-4 h-4 text-sky-600"> <span>الكاشير والمطبخ</span></label>
                        <label class="flex items-center space-x-2 space-x-reverse"><input type="checkbox" value="delivery" class="perm-check w-4 h-4 text-sky-600"> <span>الدليفري</span></label>
                        <label class="flex items-center space-x-2 space-x-reverse"><input type="checkbox" value="transactions" class="perm-check w-4 h-4 text-sky-600"> <span>سجل الفواتير</span></label>
                        <label class="flex items-center space-x-2 space-x-reverse"><input type="checkbox" value="reports" class="perm-check w-4 h-4 text-sky-600"> <span>التقارير</span></label>
                        <label class="flex items-center space-x-2 space-x-reverse"><input type="checkbox" value="inventory" class="perm-check w-4 h-4 text-sky-600"> <span>المخزون والمشتريات</span></label>
                        <label class="flex items-center space-x-2 space-x-reverse"><input type="checkbox" value="expenses" class="perm-check w-4 h-4 text-sky-600"> <span>المصروفات</span></label>
                        <label class="flex items-center space-x-2 space-x-reverse"><input type="checkbox" value="settings" class="perm-check w-4 h-4 text-sky-600"> <span>الإعدادات والمستخدمين</span></label>
                        <label class="flex items-center space-x-2 space-x-reverse"><input type="checkbox" value="admin" class="perm-check w-4 h-4 text-sky-600"> <span>إدارة البيانات (Admin)</span></label>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-end gap-3">
                <button onclick="closeModal('add-user-modal')" class="px-4 py-2 font-bold hover:bg-slate-200 rounded-lg">إلغاء</button>
                <button onclick="saveNewUser()" class="px-6 py-2 bg-slate-800 text-white font-bold rounded-lg hover:bg-slate-900">حفظ البيانات</button>
            </div>
        </div>
    </div>

    <!-- SUBSCRIPTION LOCK MODAL -->
    <div id="subscription-modal" class="fixed inset-0 bg-slate-900 z-[200] hidden flex items-center justify-center">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-8 text-center border-4 border-red-500 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-red-500"></div>
            <i class="fas fa-lock text-6xl text-red-500 mb-6"></i>
            <h2 class="text-2xl font-black text-slate-800 mb-2">النظام متوقف</h2>
            <p class="text-slate-500 mb-6">انتهت صلاحية اشتراك النظام أو لم يتم تفعيله بعد.<br>يرجى التواصل مع الدعم الفني للحصول على كود التفعيل.</p>
            
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6 text-right">
                <label class="block text-xs font-bold text-slate-700 mb-2">كود التفعيل</label>
                <input type="text" id="activation-code-input" class="w-full border border-slate-300 rounded-lg p-3 text-center font-mono text-lg focus:ring-2 focus:ring-red-500 outline-none" placeholder="HEKAYA-...">
            </div>
            
            <button onclick="activateSystem()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl shadow-lg transition transform hover:scale-[1.02]">تفعيل النظام</button>
            
            <div class="mt-6 text-xs text-slate-400">
                <p class="mb-2 font-bold">للحصول على كود التفعيل أو الدعم الفني:</p>
                <div class="flex flex-col gap-2 items-center">
                    <a href="tel:+201067765058" class="flex items-center gap-2 hover:text-slate-600 transition"><i class="fas fa-phone-alt"></i> 01067765058</a>
                    <a href="https://wa.me/201067765058" target="_blank" class="flex items-center gap-2 text-green-600 hover:text-green-700 font-bold bg-green-50 px-3 py-1 rounded-full border border-green-200 transition"><i class="fab fa-whatsapp text-lg"></i> تواصل مباشرة عبر واتساب</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD EXPENSE MODAL -->
    <div id="add-expense-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[75] hidden flex items-center justify-center">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="bg-red-600 text-white p-4 flex justify-between items-center"><h3 id="modal-expense-title" class="font-bold text-lg">تسجيل مصروف جديد</h3><button onclick="closeModal('add-expense-modal')" class="text-white/80 hover:text-white"><i class="fas fa-times text-xl"></i></button></div>
            <div class="p-6 space-y-4">
                <div><label class="block text-sm font-bold text-slate-700 mb-1">البند / الفئة</label><select id="exp-category" class="w-full border rounded p-2"><option value="rent">إيجار</option><option value="wages">رواتب وأجور</option><option value="electricity">كهرباء ومياه</option><option value="supplies">مستلزمات تشغيل</option><option value="maintenance">صيانة</option><option value="marketing">تسويق</option><option value="other">نثريات / أخرى</option></select></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">المبلغ</label><input type="number" id="exp-amount" class="w-full border rounded p-2" placeholder="0.00"></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">الوصف / ملاحظات</label><textarea id="exp-note" class="w-full border rounded p-2" rows="2"></textarea></div>
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-end gap-3"><button onclick="closeModal('add-expense-modal')" class="px-4 py-2 font-bold hover:bg-slate-200 rounded-lg">إلغاء</button><button onclick="saveExpense()" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">حفظ المصروف</button></div>
        </div>
    </div>

    <!-- ADD PURCHASE MODAL -->
    <div id="add-purchase-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden modal-enter flex flex-col max-h-[90vh]">
            <div class="bg-emerald-700 text-white p-4 flex justify-between items-center"><h3 class="font-bold text-lg">فاتورة مشتريات جديدة</h3><button onclick="closeModal('add-purchase-modal')" class="text-white/80 hover:text-white"><i class="fas fa-times text-xl"></i></button></div>
            <div class="p-6 overflow-y-auto flex-1 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-bold text-slate-700 mb-1">المورد</label><input type="text" id="pur-supplier" class="w-full border rounded p-2" placeholder="اسم المورد"></div>
                    <div><label class="block text-sm font-bold text-slate-700 mb-1">التاريخ</label><input type="date" id="pur-date" class="w-full border rounded p-2"></div>
                </div>
                <div class="border-t pt-4">
                    <h4 class="font-bold text-slate-800 mb-2">بنود الفاتورة</h4>
                    <div class="flex gap-2 mb-2">
                        <select id="pur-item-select" class="flex-1 border rounded p-2 text-sm"></select>
                        <input type="number" id="pur-item-qty" class="w-20 border rounded p-2 text-sm text-center" placeholder="الكمية">
                        <input type="number" id="pur-item-cost" class="w-24 border rounded p-2 text-sm text-center" placeholder="التكلفة">
                        <button onclick="addPurchaseItemRow()" class="bg-sky-500 text-white px-3 rounded hover:bg-sky-600"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="bg-slate-50 rounded border h-40 overflow-y-auto">
                        <table class="w-full text-xs text-right">
                            <thead class="bg-slate-100 text-slate-600 sticky top-0"><tr><th class="p-2">الصنف</th><th class="p-2">الكمية</th><th class="p-2">التكلفة</th><th class="p-2">الإجمالي</th><th class="p-2"></th></tr></thead>
                            <tbody id="pur-items-list"></tbody>
                        </table>
                    </div>
                </div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">ملاحظات</label><input type="text" id="pur-notes" class="w-full border rounded p-2"></div>
                <div class="text-xl font-black text-slate-800 text-left">الإجمالي: <span id="pur-total-display" class="text-emerald-600">0.00</span> ر.س</div>
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-end gap-3"><button onclick="closeModal('add-purchase-modal')" class="px-4 py-2 font-bold hover:bg-slate-200 rounded-lg">إلغاء</button><button onclick="savePurchase()" class="px-6 py-2 bg-emerald-700 text-white font-bold rounded-lg hover:bg-emerald-800">حفظ الفاتورة</button></div>
        </div>
    </div>

    <!-- AI/Marketing/Payment Modals (Same as before) -->
    <div id="ai-modal" class="hidden fixed inset-0 bg-black/60 z-[70] flex items-center justify-center"><div class="bg-white w-full max-w-md rounded-2xl p-0 overflow-hidden"><div class="bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white p-4 flex justify-between"><h3 class="font-bold">مساعد ذكي</h3><button onclick="closeAiModal()" class="text-white"><i class="fas fa-times"></i></button></div><div id="ai-content" class="p-6"></div></div></div>
    <div id="marketing-modal" class="hidden fixed inset-0 bg-black/60 z-[70] flex items-center justify-center"><div class="bg-white w-full max-w-lg rounded-2xl overflow-hidden"><div class="bg-indigo-600 text-white p-4 flex justify-between"><h3 class="font-bold">إعلان AI</h3><button onclick="document.getElementById('marketing-modal').classList.add('hidden')" class="text-white"><i class="fas fa-times"></i></button></div><div id="marketing-content" class="p-6"></div><div class="p-4 bg-slate-100 border-t flex justify-end"><button onclick="copyToClipboard()" class="text-indigo-600 font-bold">نسخ</button></div></div></div>
    <div id="payment-modal" class="hidden fixed inset-0 bg-black/60 z-[60] flex items-center justify-center"><div class="bg-white w-full max-w-md rounded-2xl overflow-hidden"><div class="bg-emerald-700 text-white p-4"><h3 class="font-bold text-center">دفع</h3></div><div class="p-6 space-y-4"><div class="flex justify-between"><span>المبلغ</span><span id="pay-subtotal" class="font-bold"></span></div><div class="flex justify-between"><span>الضريبة</span><span id="pay-tax" class="font-bold"></span></div><div class="bg-amber-50 p-2 rounded flex justify-between items-center"><label class="text-xs font-bold">خصم %</label><input type="number" id="pay-discount-pct" class="w-12 border text-center" onchange="updatePaymentTotals()"></div><div class="flex justify-between text-xl font-bold"><span>الإجمالي</span><span id="pay-final-total"></span></div><div class="flex items-center gap-2"><input type="checkbox" id="split-check" onchange="toggleSplit()"><span>تقسيم</span><input type="number" id="split-count" class="hidden w-12 border text-center" value="2" onchange="updatePaymentTotals()"><span id="split-amount" class="text-xs font-bold text-sky-600"></span></div><div class="grid grid-cols-3 gap-2"><button onclick="processPayment('CASH')" class="border p-2 rounded hover:bg-green-50">كاش</button><button onclick="processPayment('CARD')" class="border p-2 rounded hover:bg-blue-50">بطاقة</button><button onclick="processPayment('APPLE')" class="border p-2 rounded hover:bg-gray-50">Apple</button></div></div><div class="bg-gray-50 p-2 text-center"><button onclick="closeModal('payment-modal')" class="text-red-500 text-sm font-bold">إلغاء</button></div></div></div>

    <div id="print-area" class="hidden"></div>
    <div id="notification" class="fixed bottom-6 left-6 bg-slate-800 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-32 transition-transform duration-500 z-[70] flex items-center gap-4">
        <div class="w-8 h-8 rounded-full bg-emerald-500 flex items-center justify-center flex-shrink-0"><i class="fas fa-check text-white text-sm"></i></div>
        <div><h4 class="font-bold text-sm">تم بنجاح</h4><p id="notif-text" class="text-xs text-slate-300 mt-0.5">...</p></div>
    </div>

    <!-- Firebase Integration -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
      import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyBg30vbK9ayrQn35cohJXcBiwPzuxVIgc8",
        authDomain: "crp1-51359.firebaseapp.com",
        databaseURL: "https://crp1-51359-default-rtdb.firebaseio.com",
        projectId: "crp1-51359",
        storageBucket: "crp1-51359.firebasestorage.app",
        messagingSenderId: "728709328234",
        appId: "1:728709328234:web:a0f8e39a7d1210100b8913",
        measurementId: "G-J8PHEN82ZW"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const db = getDatabase(app);

      window.firebaseDb = db;
      window.firebaseSet = set;
      window.firebaseRef = ref;
    </script>

    <script>
        const apiKey = ""; 
        
        // --- DATA PERSISTENCE & DEFAULTS ---
        const defaultMenuItems = [
            { id: 1, name: "جمبري جامبو", price: 160, cost: 110, stockQty: 50, category: "shrimp", type: "weight", icon: "fa-shrimp", color: "text-orange-500", inStock: true },
            { id: 2, name: "استاكوزا", price: 220, cost: 150, stockQty: 30, category: "shrimp", type: "weight", icon: "fa-spider", color: "text-red-600", inStock: true },
            { id: 3, name: "سمك دنيس", price: 55, cost: 35, stockQty: 100, category: "fish", type: "weight", icon: "fa-fish", color: "text-blue-500", inStock: true },
            { id: 4, name: "سمك قاروص", price: 70, cost: 45, stockQty: 80, category: "fish", type: "weight", icon: "fa-fish", color: "text-blue-600", inStock: true },
            { id: 5, name: "فيليه هامور", price: 45, cost: 25, stockQty: 200, category: "fish", type: "unit", icon: "fa-utensils", color: "text-yellow-600", inStock: true },
            { id: 6, name: "طاجن سي فود", price: 60, cost: 35, stockQty: 40, category: "fish", type: "unit", icon: "fa-bowl-food", color: "text-orange-700", inStock: true },
            { id: 7, name: "كابوريا", price: 50, cost: 30, stockQty: 60, category: "shrimp", type: "weight", icon: "fa-certificate", color: "text-red-500", inStock: true },
            { id: 8, name: "أرز صيادية", price: 15, cost: 5, stockQty: 500, category: "sides", type: "unit", icon: "fa-bowl-rice", color: "text-amber-700", inStock: true },
            { id: 9, name: "سلطة طحينة", price: 8, cost: 2, stockQty: 200, category: "sides", type: "unit", icon: "fa-lemon", color: "text-yellow-500", inStock: true },
            { id: 10, name: "شوربة سي فود", price: 35, cost: 15, stockQty: 100, category: "shrimp", type: "unit", icon: "fa-mug-hot", color: "text-orange-400", inStock: true },
            { id: 11, name: "بيبسي", price: 5, cost: 2.5, stockQty: 240, category: "drinks", type: "unit", icon: "fa-bottle-water", color: "text-blue-800", inStock: true },
            { id: 12, name: "عصير ليمون", price: 12, cost: 4, stockQty: 100, category: "drinks", type: "unit", icon: "fa-glass-water", color: "text-green-500", inStock: true }
        ];
        const defaultUsers = [
            { id: 1, name: "المدير العام", email: "admin@hekaya.com", pass: "123456", perms: ['waiter','system','delivery','transactions','reports','inventory','expenses','admin','settings'] },
            { id: 2, name: "نادل 1", email: "waiter@hekaya.com", pass: "123456", perms: ['waiter'] },
            { id: 3, name: "كاشير", email: "cashier@hekaya.com", pass: "123456", perms: ['system','transactions'] }
        ];

        const cookingMethods = [{id:'grilled_oil',name:'مشوي زيت وليمون'},{id:'grilled_rada',name:'مشوي ردة'},{id:'singari',name:'سنجاري'},{id:'fried',name:'مقلي'},{id:'tagine',name:'طاجن'},{id:'butterfly',name:'باترفلاي'}];
        
        let cart = [], currentModalItem = null, currentPayOrderId = null, currentAdjustItemId = null, editingUserId = null, editingItemId = null, editingExpenseId = null;
        let tempPurchaseItems = [];
        const VAT_RATE = 0.15;

        // Load Data from LocalStorage
        let tablesCount = parseInt(localStorage.getItem('pos_tablesCount')) || 6;
        let menuItems = JSON.parse(localStorage.getItem('pos_menuItems')) || defaultMenuItems;
        let users = JSON.parse(localStorage.getItem('pos_users')) || defaultUsers;
        let systemOrders = JSON.parse(localStorage.getItem('pos_orders')) || [];
        let expenses = (JSON.parse(localStorage.getItem('pos_expenses')) || []).map(e => ({...e, id: e.id || Date.now() + Math.random()}));
        let purchases = JSON.parse(localStorage.getItem('pos_purchases')) || [];
        let stockMovements = JSON.parse(localStorage.getItem('pos_stockMovements')) || [];
        let subscriptionCode = localStorage.getItem('pos_subscription_code') || '';

        let currentUser = null;

        function saveData() {
            localStorage.setItem('pos_tablesCount', tablesCount);
            localStorage.setItem('pos_menuItems', JSON.stringify(menuItems));
            localStorage.setItem('pos_users', JSON.stringify(users));
            localStorage.setItem('pos_orders', JSON.stringify(systemOrders));
            localStorage.setItem('pos_expenses', JSON.stringify(expenses));
            localStorage.setItem('pos_purchases', JSON.stringify(purchases));
            localStorage.setItem('pos_stockMovements', JSON.stringify(stockMovements));
            localStorage.setItem('pos_subscription_code', subscriptionCode);
            
            // Save to Firebase (Backup)
            if(window.firebaseDb && window.firebaseSet && window.firebaseRef) {
                window.firebaseSet(window.firebaseRef(window.firebaseDb, 'backup'), {
                    tablesCount,
                    menuItems,
                    users,
                    orders: systemOrders,
                    expenses,
                    purchases,
                    stockMovements,
                    subscriptionCode,
                    lastUpdated: new Date().toISOString()
                }).catch(err => console.error("Firebase Save Error:", err));
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            
            const user = users.find(u => u.email === email && u.pass === pass);
            
            if(user) {
                // Check Subscription BEFORE logging in
                const subStatus = validateSubscription(subscriptionCode);
                if (!subStatus.valid) {
                    document.getElementById('subscription-modal').classList.remove('hidden');
                    return; // Stop login
                }

                currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('user-display-name').innerText = `مرحباً، ${user.name}`;
                updateNavBasedOnPerms();
                
                // Route to first available view
                if(user.perms.length > 0) {
                    if(user.perms.includes('admin')) switchView('admin');
                    else switchView(user.perms[0]);
                } else {
                    showNotification('لا توجد صلاحيات لهذا المستخدم', 'error');
                }
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-error').classList.add('hidden');
        }

        function updateNavBasedOnPerms() {
            const btns = ['waiter', 'system', 'delivery', 'transactions', 'reports', 'inventory', 'expenses', 'admin', 'settings'];
            btns.forEach(view => {
                const btn = document.getElementById(`btn-${view}`);
                if(currentUser.perms.includes(view)) {
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            });
        }

        // --- SUBSCRIPTION SYSTEM ---
        function validateSubscription(code) {
            if (!code) return { valid: false, reason: 'missing' };
            code = code.trim();
            if (!code.startsWith('HEKAYA-')) return { valid: false, reason: 'invalid_format' };

            try {
                const base64 = code.replace('HEKAYA-', '').replace(/\s/g, '');
                // Handle Unicode (Arabic) characters decoding correctly
                let jsonStr;
                try { jsonStr = decodeURIComponent(escape(atob(base64))); } 
                catch (e) { jsonStr = atob(base64); }
                
                const data = JSON.parse(jsonStr);
                
                if (data.secret !== 'hekaya_secure_key_2025') return { valid: false, reason: 'invalid' };
                
                const now = new Date().getTime();
                if (now > data.exp) return { valid: false, reason: 'expired', exp: data.exp };
                
                return { valid: true, exp: data.exp, client: data.client };
            } catch (e) {
                return { valid: false, reason: 'error' };
            }
        }

        function activateSystem() {
            const code = document.getElementById('activation-code-input').value.trim();
            const result = validateSubscription(code);
            
            if (result.valid) {
                subscriptionCode = code;
                saveData();
                document.getElementById('subscription-modal').classList.add('hidden');
                showNotification('تم تفعيل النظام بنجاح');
            } else {
                alert('كود التفعيل غير صحيح أو منتهي الصلاحية!');
            }
        }

        function updateSubscriptionFromSettings() {
            const code = document.getElementById('settings-sub-code').value.trim();
            const result = validateSubscription(code);
            if (result.valid) {
                subscriptionCode = code;
                saveData();
                renderSubscriptionStatus();
                showNotification('تم تجديد الاشتراك بنجاح');
                document.getElementById('settings-sub-code').value = '';
            } else {
                showNotification('الكود غير صالح', 'error');
            }
        }

        function renderSubscriptionStatus() {
            const result = validateSubscription(subscriptionCode);
            const statusText = document.getElementById('sub-status-text');
            const expiryText = document.getElementById('sub-expiry-text');
            
            if (result.valid) {
                const date = new Date(result.exp).toLocaleDateString('ar-EG');
                statusText.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle"></i> نشط</span>`;
                expiryText.innerText = `ينتهي في: ${date}`;
            } else {
                statusText.innerHTML = `<span class="text-red-600"><i class="fas fa-times-circle"></i> غير نشط / منتهي</span>`;
                expiryText.innerText = `يرجى التجديد فوراً`;
            }
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderMenu('all');
            initTables();
            document.getElementById('settings-table-count').value = tablesCount;
        });

        // --- NAVIGATION ---
        function switchView(viewName) {
            if(!currentUser.perms.includes(viewName)) {
                showNotification('ليس لديك صلاحية الوصول لهذه الصفحة', 'error');
                return;
            }

            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden', 'opacity-0'));
            document.querySelectorAll('.nav-btn').forEach(el => el.className = el.className.replace('bg-sky-500 text-white shadow-lg', 'text-slate-400 hover:text-white hover:bg-slate-700/50'));

            const view = document.getElementById(viewName + '-view');
            const btn = document.getElementById('btn-' + viewName);
            
            if(view) { view.classList.remove('hidden'); setTimeout(() => view.classList.remove('opacity-0'), 50); }
            if(btn) btn.className = "nav-btn flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-all bg-sky-500 text-white shadow-lg";

            if (viewName === 'system') renderSystemOrders();
            if (viewName === 'delivery') renderDeliveryOrders();
            if (viewName === 'transactions') renderTransactions();
            if (viewName === 'reports') renderReports();
            if (viewName === 'inventory') renderInventory();
            if (viewName === 'expenses') renderExpenses();
            if (viewName === 'admin') renderAdminTable();
            if (viewName === 'settings') {
                document.getElementById('settings-table-count').value = tablesCount;
                renderSubscriptionStatus();
                renderUsersTable();
            }
        }

        // --- USER MANAGEMENT ---
        function renderUsersTable() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            users.forEach(u => {
                const permsBadges = u.perms.map(p => `<span class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded mx-1">${p}</span>`).join('');
                tbody.innerHTML += `
                    <tr class="bg-white border-b hover:bg-slate-50">
                        <td class="px-6 py-4 font-bold text-slate-900">${u.name}</td>
                        <td class="px-6 py-4">${u.email}</td>
                        <td class="px-6 py-4">${permsBadges}</td>
                        <td class="px-6 py-4 text-center flex justify-center gap-3">
                            <button onclick="editUser(${u.id})" class="text-sky-500 hover:text-sky-700"><i class="fas fa-edit"></i></button>
                            ${u.id !== 1 ? `<button onclick="deleteUser(${u.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>` : ''}
                        </td>
                    </tr>
                `;
            });
        }

        function openAddUserModal() {
            editingUserId = null;
            document.getElementById('modal-user-title').innerHTML = '<i class="fas fa-user-plus"></i> مستخدم جديد';
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-email').value = '';
            document.getElementById('new-user-pass').value = '';
            document.querySelectorAll('.perm-check').forEach(c => c.checked = false);
            document.getElementById('add-user-modal').classList.remove('hidden');
        }

        function editUser(id) {
            const u = users.find(x => x.id === id);
            if(!u) return;
            editingUserId = id;
            document.getElementById('modal-user-title').innerHTML = '<i class="fas fa-user-edit"></i> تعديل مستخدم';
            document.getElementById('new-user-name').value = u.name;
            document.getElementById('new-user-email').value = u.email;
            document.getElementById('new-user-pass').value = u.pass;
            document.querySelectorAll('.perm-check').forEach(c => c.checked = u.perms.includes(c.value));
            document.getElementById('add-user-modal').classList.remove('hidden');
        }

        function saveNewUser() {
            const name = document.getElementById('new-user-name').value;
            const email = document.getElementById('new-user-email').value;
            const pass = document.getElementById('new-user-pass').value;
            const perms = Array.from(document.querySelectorAll('.perm-check:checked')).map(c => c.value);

            if(!name || !email || !pass || perms.length === 0) {
                showNotification('يرجى ملء كافة البيانات واختيار صلاحية واحدة على الأقل', 'error');
                return;
            }

            if(editingUserId) {
                const u = users.find(x => x.id === editingUserId);
                if(u) { u.name = name; u.email = email; u.pass = pass; u.perms = perms; }
                showNotification('تم تحديث بيانات المستخدم');
            } else {
                users.push({ id: Date.now(), name, email, pass, perms });
                showNotification('تم إضافة المستخدم بنجاح');
            }
            saveData();
            renderUsersTable();
            closeModal('add-user-modal');
        }

        function deleteUser(id) {
            if(confirm('حذف المستخدم؟')) {
                users = users.filter(u => u.id !== id);
                saveData();
                renderUsersTable();
            }
        }

        // --- SHARED FUNCTIONS (Menu, Cart, Orders) ---
        function initTables() {
            const select = document.getElementById('table-select');
            select.innerHTML = '';
            for(let i=1; i<=tablesCount; i++) {
                const opt = document.createElement('option');
                opt.value = i; opt.text = i + (i === 6 ? ' (VIP)' : '');
                select.appendChild(opt);
            }
        }
        function saveTableSettings() {
            const count = parseInt(document.getElementById('settings-table-count').value);
            if(count && count > 0) { tablesCount = count; saveData(); initTables(); showNotification('تم التحديث'); }
        }
        function toggleDeliveryFields() {
            const type = document.getElementById('order-type-select').value;
            if (type === 'delivery') {
                document.getElementById('table-select-wrapper').classList.add('hidden');
                document.getElementById('delivery-fields').classList.remove('hidden');
                document.getElementById('delivery-fields').classList.add('flex');
            } else {
                document.getElementById('table-select-wrapper').classList.remove('hidden');
                document.getElementById('delivery-fields').classList.add('hidden');
                document.getElementById('delivery-fields').classList.remove('flex');
            }
        }
        function filterMenu(category) {
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderMenu(category);
        }
        function renderMenu(category) {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';
            const filtered = category === 'all' ? menuItems : menuItems.filter(i => i.category === category);
            filtered.forEach(item => {
                const opacity = item.inStock ? 'opacity-100' : 'opacity-50 grayscale pointer-events-none';
                const div = document.createElement('div');
                div.className = `item-card bg-white p-5 rounded-2xl shadow-sm border border-slate-100 cursor-pointer flex flex-col items-center text-center h-full justify-between group ${opacity}`;
                div.onclick = () => item.inStock && handleItemClick(item);
                div.innerHTML = `<div class="mb-4 w-16 h-16 rounded-full bg-slate-50 flex items-center justify-center text-3xl ${item.color} shadow-inner"><i class="fas ${item.icon}"></i></div><div class="w-full"><h3 class="font-bold text-slate-800 text-base mb-2">${item.name}</h3><div class="flex justify-center items-center gap-2"><span class="text-sky-600 font-extrabold text-lg">${item.price}</span><span class="text-xs text-slate-400 font-medium">/${item.type==='weight'?'كجم':'قطعة'}</span></div></div>${!item.inStock?'<span class="text-red-500 font-bold text-xs mt-2">نفذت الكمية</span>':''}`;
                grid.appendChild(div);
            });
        }
        function handleItemClick(item) {
            if (item.type === 'weight' || item.category === 'fish' || item.category === 'shrimp') openCustomModal(item); else addToCart(item, 1);
        }
        function openCustomModal(item) {
            currentModalItem = item;
            document.getElementById('modal-item-name').innerText = item.name;
            document.getElementById('qty-label').innerText = item.type === 'weight' ? 'الوزن (كيلوجرام)' : 'العدد';
            document.getElementById('modal-qty').value = "1.0";
            document.getElementById('modal-qty').step = item.type === 'weight' ? "0.1" : "1";
            document.getElementById('modal-notes').value = "";
            const optsContainer = document.getElementById('cooking-options');
            optsContainer.innerHTML = '';
            cookingMethods.forEach((method, index) => {
                const checked = index === 0 ? 'checked' : '';
                optsContainer.innerHTML += `<label class="cursor-pointer border p-2 rounded-lg hover:bg-sky-50 has-[:checked]:bg-sky-100 has-[:checked]:border-sky-500 transition"><input type="radio" name="cookingMethod" value="${method.name}" class="hidden" ${checked}><span class="text-sm font-bold text-slate-700 block text-center">${method.name}</span></label>`;
            });
            document.getElementById('custom-modal').classList.remove('hidden');
        }
        function adjustModalQty(d) { let v = parseFloat(document.getElementById('modal-qty').value)+d; if(v<0.1)v=0.1; document.getElementById('modal-qty').value=v.toFixed(1); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function confirmCustomization() { addToCart(currentModalItem, parseFloat(document.getElementById('modal-qty').value), document.querySelector('input[name="cookingMethod"]:checked').value, document.getElementById('modal-notes').value); closeModal('custom-modal'); }
        function addToCart(item, qty, method=null, notes="") {
            if(method) cart.push({...item, qty, method, notes, cartId: Date.now()});
            else { const ex = cart.find(c=>c.id===item.id&&!c.method); if(ex) ex.qty+=qty; else cart.push({...item, qty, method, notes, cartId: Date.now()}); }
            renderCart(); showNotification('تمت الإضافة للسلة');
        }
        function removeFromCart(id) { cart = cart.filter(c=>c.cartId!==id); renderCart(); }
        function renderCart() {
            const con = document.getElementById('cart-items'); con.innerHTML=''; let total=0;
            cart.forEach(i => {
                total+=i.price*i.qty;
                con.innerHTML += `<div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex justify-between items-start"><div><div class="font-bold text-sm text-slate-800">${i.name} <span class="text-xs text-slate-400">x${i.qty}</span></div>${i.method?`<div class="text-[10px] text-sky-600 mt-1">${i.method} | ${i.notes}</div>`:''}<div class="text-xs font-bold text-slate-500 mt-1">${(i.price*i.qty).toFixed(1)} ر.س</div></div><button onclick="removeFromCart(${i.cartId})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash-alt"></i></button></div>`;
            });
            document.getElementById('cart-total').innerText = total.toFixed(2)+' ر.س';
        }
        function submitOrder() {
            if(cart.length===0) return showNotification('السلة فارغة','error');
            const type = document.getElementById('order-type-select').value;
            const sub = cart.reduce((s,i)=>s+(i.price*i.qty),0);
            let order = { id: Date.now(), type, items: [...cart], subtotal: sub, tax: sub*VAT_RATE, total: sub*1.15, finalTotal: sub*1.15, time: new Date().toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'}), status: 'pending', isCancelled: false };
            if(type==='delivery') { order.customer = {name: document.getElementById('cust-name').value||'عميل', phone: document.getElementById('cust-phone').value||'-', address: document.getElementById('cust-address').value||'-'}; order.table='دليفري'; order.deliveryStatus='preparing'; document.getElementById('cust-name').value=''; } else order.table=document.getElementById('table-select').value;
            
            // Deduct Stock
            order.items.forEach(orderItem => {
                const menuItem = menuItems.find(m => m.id === orderItem.id);
                if(menuItem) {
                    menuItem.stockQty -= orderItem.qty;
                    logStockMovement(menuItem.id, menuItem.name, -orderItem.qty, 'sale', `طلب #${order.id}`);
                }
            });

            systemOrders.unshift(order); saveData(); cart=[]; renderCart(); showNotification('تم إرسال الطلب وخصم المخزون');
        }
        function renderSystemOrders() {
            const con=document.getElementById('orders-container'); con.innerHTML='';
            const active=systemOrders.filter(o=>o.type==='dine-in'&&!o.isCancelled);
            if(active.length===0) document.getElementById('no-orders-msg').classList.remove('hidden'); else document.getElementById('no-orders-msg').classList.add('hidden');
            document.getElementById('stats-revenue').innerText = systemOrders.filter(o=>o.status==='paid').reduce((s,o)=>s+o.finalTotal,0).toFixed(0)+' ر.س';
            con.innerHTML = active.map(o=>{
                let items=o.items.map(i=>`<div class="flex justify-between text-xs py-1 border-b last:border-0"><span>${i.qty}x ${i.name}</span><span class="font-bold">${(i.price*i.qty).toFixed(0)}</span></div>`).join('');
                return `<div class="bg-white rounded-2xl shadow-lg border overflow-hidden flex flex-col"><div class="p-4 bg-slate-50 flex justify-between border-b"><div><h3 class="font-bold">طاولة ${o.table}</h3><span class="text-xs text-slate-400">#${o.id.toString().slice(-4)}</span></div><span class="px-2 py-1 rounded text-xs font-bold border ${o.status==='paid'?'bg-emerald-100 text-emerald-700':'bg-amber-50 text-amber-600'}">${o.status==='paid'?'مدفوع':'انتظار'}</span></div><div class="p-4 flex-1 overflow-y-auto max-h-40 space-y-1">${items}</div><div class="p-3 bg-slate-50 border-t flex gap-2"><button onclick="printKitchenTicket(${o.id})" class="flex-1 py-2 border rounded bg-white hover:bg-orange-50 text-orange-600 text-xs font-bold">مطبخ</button><button onclick="openPaymentModal(${o.id})" class="flex-1 py-2 border rounded bg-sky-600 hover:bg-sky-700 text-white text-xs font-bold">دفع</button></div></div>`;
            }).join('');
        }
        function renderDeliveryOrders() {
            const prep=document.getElementById('delivery-prep'), out=document.getElementById('delivery-out'), done=document.getElementById('delivery-done');
            prep.innerHTML=''; out.innerHTML=''; done.innerHTML='';
            const ords = systemOrders.filter(o=>o.type==='delivery'&&!o.isCancelled);
            let c={preparing:0,out:0,delivered:0};
            ords.forEach(o=>{ 
                if(c[o.deliveryStatus] !== undefined) c[o.deliveryStatus]++; 
                const card=createDelCard(o); 
                if(o.deliveryStatus==='out')out.appendChild(card); 
                else if(o.deliveryStatus==='delivered')done.appendChild(card); 
                else prep.appendChild(card); 
            });
            document.getElementById('count-prep').innerText=c.preparing; document.getElementById('count-out').innerText=c.out; document.getElementById('count-done').innerText=c.delivered;
        }
        function createDelCard(o) {
            const d=document.createElement('div'); d.className="bg-slate-50 p-3 rounded-xl border text-sm";
            let btn = o.deliveryStatus==='preparing' ? `<button onclick="updDel(${o.id},'out')" class="w-full mt-2 bg-orange-500 text-white py-1 rounded font-bold">خرج للتوصيل</button>` : (o.deliveryStatus==='out' ? `<button onclick="updDel(${o.id},'delivered')" class="w-full mt-2 bg-green-600 text-white py-1 rounded font-bold">تم التسليم</button>`:'');
            d.innerHTML=`<div class="flex justify-between font-bold mb-1"><span>${o.customer.name}</span><span>#${o.id.toString().slice(-4)}</span></div><div class="text-xs text-slate-500 mb-2">${o.customer.phone}<br>${o.customer.address}</div><div class="font-bold text-right">${o.finalTotal.toFixed(2)} ر.س</div>${btn}<div class="mt-2 flex gap-1"><button onclick="printInvoice(${o.id})" class="flex-1 bg-white border text-xs py-1 rounded">فاتورة</button>${o.status!=='paid'?`<button onclick="openPaymentModal(${o.id})" class="flex-1 bg-sky-100 text-sky-700 text-xs py-1 rounded">دفع</button>`:'<span class="flex-1 text-center text-xs text-green-600 font-bold py-1">مدفوع</span>'}</div>`;
            return d;
        }
        function updDel(id,s) { const o=systemOrders.find(x=>x.id===id); if(o){o.deliveryStatus=s; saveData(); renderDeliveryOrders();} }
        function renderTransactions() { document.getElementById('transactions-table-body').innerHTML = systemOrders.map(o=>`<tr class="bg-white border-b hover:bg-slate-50 ${o.isCancelled?'opacity-50':''}"><td class="px-6 py-4 font-bold">#${o.id.toString().slice(-4)}</td><td class="px-6 py-4">${o.type==='delivery'?'دليفري':`طاولة ${o.table}`}</td><td class="px-6 py-4">${o.time}</td><td class="px-6 py-4 font-bold">${o.finalTotal.toFixed(2)}</td><td class="px-6 py-4">${o.isCancelled?'ملغاة':(o.status==='paid'?'مدفوعة':'معلقة')}</td><td class="px-6 py-4 text-center">${!o.isCancelled?`<button onclick="cancelOrder(${o.id})" class="text-red-500 text-xs border border-red-200 px-3 py-1 rounded">إلغاء</button>`:'-'}</td></tr>`).join(''); }
        function cancelOrder(id) { if(confirm('إلغاء؟')) { const o=systemOrders.find(x=>x.id===id); if(o){o.isCancelled=true; o.status='cancelled'; saveData(); renderTransactions();} } }
        
        // --- REPORTS & FINANCIALS ---
        function renderReports() {
            const v = systemOrders.filter(o=>!o.isCancelled);
            const totalSales = v.reduce((s,o)=>s+o.finalTotal,0);
            
            // Calculate COGS (Cost of Goods Sold)
            let totalCOGS = 0;
            v.forEach(o => {
                o.items.forEach(i => {
                    const item = menuItems.find(m => m.id === i.id);
                    if(item) totalCOGS += (item.cost * i.qty);
                });
            });

            // Calculate Expenses
            const totalExpenses = expenses.reduce((s,e) => s + e.amount, 0);

            // Net Profit
            const netProfit = totalSales - totalCOGS - totalExpenses;

            document.getElementById('report-total-sales').innerText = totalSales.toFixed(2)+' ر.س';
            document.getElementById('report-cogs').innerText = totalCOGS.toFixed(2)+' ر.س';
            document.getElementById('report-expenses').innerText = totalExpenses.toFixed(2)+' ر.س';
            document.getElementById('report-net-profit').innerText = netProfit.toFixed(2)+' ر.س';
            document.getElementById('report-net-profit').className = `text-2xl font-black mt-2 ${netProfit >= 0 ? 'text-purple-700' : 'text-red-600'}`;

            document.getElementById('report-total-orders').innerText = v.length;
            document.getElementById('report-cancelled').innerText = systemOrders.filter(o=>o.isCancelled).length;
            
            // Stock Value
            const stockVal = menuItems.reduce((s,i) => s + (i.stockQty * i.cost), 0);
            document.getElementById('report-stock-value').innerText = stockVal.toFixed(2) + ' ر.س';

            let c={}; 
            v.forEach(o=>o.items.forEach(i=> { c[i.category] = (c[i.category]||0) + i.qty; }));
            const t = Object.values(c).reduce((a,b)=>a+b,0)||1;
            
            const catNames = {fish:'أسماك', shrimp:'جمبري', sides:'جانبي', drinks:'مشروبات'};
            document.getElementById('category-bars').innerHTML = Object.keys(c).map(cat => {
                const pct = (c[cat]/t*100).toFixed(1);
                const name = catNames[cat] || cat;
                return `<div><div class="flex justify-between text-sm font-bold"><span>${name}</span><span>${pct}%</span></div><div class="w-full bg-slate-100 h-3 rounded-full mt-1"><div class="bg-sky-500 h-3 rounded-full" style="width:${pct}%"></div></div></div>`;
            }).join('');
        }

        // --- INVENTORY & PURCHASES ---
        function switchInventoryTab(tab) {
            document.getElementById('inv-content-stock').classList.add('hidden');
            document.getElementById('inv-content-purchases').classList.add('hidden');
            document.getElementById('inv-content-movements').classList.add('hidden');
            document.getElementById('tab-inv-stock').className = "inv-tab-btn px-4 py-2 font-bold text-slate-500 hover:text-sky-600";
            document.getElementById('tab-inv-purchases').className = "inv-tab-btn px-4 py-2 font-bold text-slate-500 hover:text-sky-600";
            document.getElementById('tab-inv-movements').className = "inv-tab-btn px-4 py-2 font-bold text-slate-500 hover:text-sky-600";
            
            document.getElementById(`inv-content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-inv-${tab}`).className = "inv-tab-btn px-4 py-2 font-bold text-sky-600 border-b-2 border-sky-600";
        }
        function renderInventory() {
            // Stock Table
            document.getElementById('inventory-stock-body').innerHTML = menuItems.map(i => {
                const val = i.stockQty * i.cost;
                const status = i.stockQty < 10 ? '<span class="text-red-500 font-bold">منخفض</span>' : '<span class="text-green-500 font-bold">جيد</span>';
                return `<tr class="bg-white border-b"><td class="px-6 py-4 font-bold">${i.name}</td><td class="px-6 py-4 font-bold text-sky-700">${i.stockQty}</td><td class="px-6 py-4">${i.cost}</td><td class="px-6 py-4">${i.price}</td><td class="px-6 py-4 font-bold">${val.toFixed(0)}</td><td class="px-6 py-4">${status}</td><td class="px-6 py-4 text-center"><button onclick="openStockAdjustModal(${i.id})" class="text-sky-600 hover:text-sky-800"><i class="fas fa-edit"></i></button></td></tr>`;
            }).join('');
            // Purchases Table
            document.getElementById('inventory-purchases-body').innerHTML = purchases.map(p => `
                <tr class="bg-white border-b">
                    <td class="px-6 py-4 font-bold">#${p.id}</td>
                    <td class="px-6 py-4">${p.date}</td>
                    <td class="px-6 py-4">${p.supplier}</td>
                    <td class="px-6 py-4 font-bold text-emerald-600">${p.total.toFixed(2)}</td>
                    <td class="px-6 py-4 text-xs">${p.notes}</td>
                    <td class="px-6 py-4 text-xs text-slate-500">${p.items.length} أصناف</td>
                    <td class="px-6 py-4 text-center"><button onclick="deletePurchase(${p.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
            // Movements Table
            document.getElementById('inventory-movements-body').innerHTML = stockMovements.map(m => `
                <tr class="bg-white border-b"><td class="px-6 py-4 text-xs">${m.date}</td><td class="px-6 py-4 font-bold">${m.itemName}</td><td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold ${m.qty>0?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${m.type==='sale'?'بيع':(m.type==='purchase'?'شراء':'تعديل')}</span></td><td class="px-6 py-4 font-bold" dir="ltr">${m.qty>0?'+':''}${m.qty}</td><td class="px-6 py-4 text-xs">${m.user}</td><td class="px-6 py-4 text-xs text-slate-500">${m.note}</td></tr>
            `).join('');
        }
        function openAddPurchaseModal() {
            tempPurchaseItems = [];
            document.getElementById('pur-supplier').value = '';
            document.getElementById('pur-date').valueAsDate = new Date();
            document.getElementById('pur-notes').value = '';
            document.getElementById('pur-item-select').innerHTML = menuItems.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
            renderPurchaseItems();
            document.getElementById('add-purchase-modal').classList.remove('hidden');
        }
        function addPurchaseItemRow() {
            const id = parseInt(document.getElementById('pur-item-select').value);
            const qty = parseFloat(document.getElementById('pur-item-qty').value);
            const cost = parseFloat(document.getElementById('pur-item-cost').value);
            if(qty > 0 && cost >= 0 && id) {
                const item = menuItems.find(i => i.id === id);
                if(item) {
                    tempPurchaseItems.push({ id, name: item.name, qty, cost, total: qty*cost });
                    renderPurchaseItems();
                    document.getElementById('pur-item-qty').value = '';
                    document.getElementById('pur-item-cost').value = '';
                }
            }
        }
        function renderPurchaseItems() {
            const total = tempPurchaseItems.reduce((s,i)=>s+i.total,0);
            document.getElementById('pur-total-display').innerText = total.toFixed(2);
            document.getElementById('pur-items-list').innerHTML = tempPurchaseItems.map((i,idx) => `<tr class="border-b"><td class="p-2">${i.name}</td><td class="p-2">${i.qty}</td><td class="p-2">${i.cost}</td><td class="p-2">${i.total}</td><td class="p-2"><button onclick="tempPurchaseItems.splice(${idx},1);renderPurchaseItems()" class="text-red-500"><i class="fas fa-times"></i></button></td></tr>`).join('');
        }
        function savePurchase() {
            if(tempPurchaseItems.length === 0) return;
            const total = tempPurchaseItems.reduce((s,i)=>s+i.total,0);
            const pur = {
                id: Date.now(),
                supplier: document.getElementById('pur-supplier').value || 'مورد عام',
                date: document.getElementById('pur-date').value,
                items: [...tempPurchaseItems],
                total: total,
                notes: document.getElementById('pur-notes').value
            };
            // Update Stock & Cost
            pur.items.forEach(pi => {
                const item = menuItems.find(m => m.id === pi.id);
                if(item) {
                    // Weighted Average Cost Calculation
                    const oldVal = item.stockQty * item.cost;
                    const newVal = pi.qty * pi.cost;
                    item.stockQty += pi.qty;
                    item.cost = (oldVal + newVal) / item.stockQty; // Update cost average
                    logStockMovement(item.id, item.name, pi.qty, 'purchase', `فاتورة #${pur.id}`);
                }
            });
            purchases.unshift(pur);
            saveData();
            closeModal('add-purchase-modal');
            renderInventory();
            showNotification('تم حفظ فاتورة المشتريات وتحديث المخزون');
        }

        function deletePurchase(id) {
            if(confirm('حذف الفاتورة؟ لن يتم التراجع عن تأثير المخزون تلقائياً.')) { purchases = purchases.filter(p => p.id !== id); saveData(); renderInventory(); }
        }
        
        function logStockMovement(itemId, itemName, qty, type, note) {
            stockMovements.unshift({ id: Date.now(), date: new Date().toLocaleString('ar-EG'), itemId, itemName, qty, type, note, user: currentUser ? currentUser.name : 'System' });
        }

        function openStockAdjustModal(id) {
            const item = menuItems.find(i => i.id === id);
            if(!item) return;
            currentAdjustItemId = id;
            document.getElementById('adjust-item-name').innerText = `تعديل مخزون: ${item.name}`;
            document.getElementById('adjust-qty').value = '';
            document.getElementById('stock-adjust-modal').classList.remove('hidden');
        }
        function saveStockAdjustment() {
            const qty = parseFloat(document.getElementById('adjust-qty').value);
            const reason = document.getElementById('adjust-reason').value;
            if(qty === 0 || isNaN(qty)) return;
            const item = menuItems.find(i => i.id === currentAdjustItemId);
            if(item) {
                item.stockQty += qty;
                logStockMovement(item.id, item.name, qty, 'adjustment', reason);
                saveData();
                closeModal('stock-adjust-modal');
                renderInventory();
                showNotification('تم تعديل المخزون');
            }
        }

        // --- EXPENSES ---
        function renderExpenses() {
            document.getElementById('expenses-table-body').innerHTML = expenses.map((e, idx) => `
                <tr class="bg-white border-b hover:bg-slate-50">
                    <td class="px-6 py-4">${e.date}</td>
                    <td class="px-6 py-4 font-bold text-slate-700">${getExpCatName(e.category)}</td>
                    <td class="px-6 py-4 font-bold text-red-600">${e.amount.toFixed(2)}</td>
                    <td class="px-6 py-4 text-sm">${e.note}</td>
                    <td class="px-6 py-4 text-xs text-slate-400">${e.user}</td>
                    <td class="px-6 py-4 text-center flex justify-center gap-3">
                        <button onclick="editExpense(${e.id})" class="text-sky-500 hover:text-sky-700"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteExpense(${e.id})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }
        function getExpCatName(c) { const m={rent:'إيجار',wages:'رواتب',electricity:'كهرباء',supplies:'مستلزمات',maintenance:'صيانة',marketing:'تسويق',other:'أخرى'}; return m[c]||c; }
        function openAddExpenseModal() { 
            editingExpenseId = null;
            document.getElementById('modal-expense-title').innerText = 'تسجيل مصروف جديد';
            document.getElementById('exp-amount').value=''; document.getElementById('exp-note').value=''; 
            document.getElementById('add-expense-modal').classList.remove('hidden'); 
        }
        function editExpense(id) {
            const e = expenses.find(x => x.id === id);
            if(!e) return;
            editingExpenseId = id;
            document.getElementById('modal-expense-title').innerText = 'تعديل مصروف';
            document.getElementById('exp-category').value = e.category;
            document.getElementById('exp-amount').value = e.amount;
            document.getElementById('exp-note').value = e.note;
            document.getElementById('add-expense-modal').classList.remove('hidden');
        }
        function saveExpense() {
            const amt = parseFloat(document.getElementById('exp-amount').value);
            if(!amt) return;
            
            if(editingExpenseId) {
                const e = expenses.find(x => x.id === editingExpenseId);
                if(e) { e.category = document.getElementById('exp-category').value; e.amount = amt; e.note = document.getElementById('exp-note').value; }
                showNotification('تم تعديل المصروف');
            } else {
                expenses.unshift({
                    id: Date.now(),
                    date: new Date().toLocaleDateString('ar-EG'),
                    category: document.getElementById('exp-category').value,
                    amount: amt,
                    note: document.getElementById('exp-note').value,
                    user: currentUser.name
                });
                showNotification('تم تسجيل المصروف');
            }
            saveData();
            closeModal('add-expense-modal');
            renderExpenses();
        }
        function deleteExpense(id) { if(confirm('حذف المصروف؟')) { expenses = expenses.filter(e => e.id !== id); saveData(); renderExpenses(); } }

        // --- ADMIN UPDATES ---
        function renderAdminTable() { document.getElementById('admin-table-body').innerHTML = menuItems.map(i=>`<tr class="bg-white border-b"><td class="px-6 py-4 font-bold">${i.name}</td><td class="px-6 py-4">${i.category}</td><td class="px-6 py-4"><input type="number" value="${i.price}" onchange="updatePrice(${i.id},this.value)" class="w-20 border rounded text-center"></td><td class="px-6 py-4"><input type="number" value="${i.cost.toFixed(2)}" onchange="updateCost(${i.id},this.value)" class="w-20 border rounded text-center bg-slate-50"></td><td class="px-6 py-4"><input type="checkbox" ${i.inStock?'checked':''} onchange="toggleStock(${i.id})"></td><td class="px-6 py-4 text-center flex justify-center gap-3"><button onclick="editItem(${i.id})" class="text-sky-600 hover:text-sky-800"><i class="fas fa-edit"></i></button><button onclick="deleteItem(${i.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td></tr>`).join(''); }
        function updatePrice(id,p) { const i=menuItems.find(x=>x.id===id); if(i) { i.price=parseFloat(p); saveData(); } }
        function updateCost(id,c) { const i=menuItems.find(x=>x.id===id); if(i) { i.cost=parseFloat(c); saveData(); } }
        function toggleStock(id) { const i=menuItems.find(x=>x.id===id); if(i) { i.inStock=!i.inStock; saveData(); } }
        
        function openAddItemModal() { 
            editingItemId = null;
            document.getElementById('modal-item-title').innerText = 'إضافة صنف';
            document.getElementById('new-item-name').value=''; 
            document.getElementById('new-item-price').value='';
            document.getElementById('new-item-cost').value='';
            document.getElementById('add-item-modal').classList.remove('hidden'); 
        }
        
        function editItem(id) {
            const i = menuItems.find(x => x.id === id);
            if(!i) return;
            editingItemId = id;
            document.getElementById('modal-item-title').innerText = 'تعديل صنف';
            document.getElementById('new-item-name').value = i.name;
            document.getElementById('new-item-price').value = i.price;
            document.getElementById('new-item-cost').value = i.cost;
            document.getElementById('new-item-type').value = i.type;
            document.getElementById('new-item-category').value = i.category;
            document.getElementById('add-item-modal').classList.remove('hidden');
        }

        function saveNewItem() { 
            const n=document.getElementById('new-item-name').value, p=document.getElementById('new-item-price').value, c=document.getElementById('new-item-cost').value;
            if(n&&p) { 
                if(editingItemId) {
                    const i = menuItems.find(x => x.id === editingItemId);
                    if(i) {
                        i.name = n; i.price = parseFloat(p); i.cost = parseFloat(c)||0;
                        i.category = document.getElementById('new-item-category').value;
                        i.type = document.getElementById('new-item-type').value;
                    }
                    showNotification('تم تحديث الصنف');
                } else {
                    menuItems.push({id:Date.now(), name:n, price:parseFloat(p), cost:parseFloat(c)||0, stockQty:0, category:document.getElementById('new-item-category').value, type:document.getElementById('new-item-type').value, icon:'fa-circle', color:'text-gray-500', inStock:true}); 
                    showNotification('تم إضافة الصنف');
                }
                saveData(); closeModal('add-item-modal'); renderAdminTable(); 
            } 
        }

        function deleteItem(id) {
            if(confirm('هل أنت متأكد من حذف هذا الصنف؟')) {
                menuItems = menuItems.filter(i => i.id !== id);
                saveData();
                renderAdminTable();
                renderMenu('all'); // Update menu view as well
            }
        }
        
        // Payment & Print Utils (Condensed)
        function openPaymentModal(id){currentPayOrderId=id; const o=systemOrders.find(x=>x.id===id); if(o){document.getElementById('pay-subtotal').innerText=o.subtotal.toFixed(2); document.getElementById('pay-tax').innerText=o.tax.toFixed(2); updatePaymentTotals(); document.getElementById('payment-modal').classList.remove('hidden');}}
        function updatePaymentTotals(){const o=systemOrders.find(x=>x.id===currentPayOrderId); if(!o)return; const sub=o.subtotal+o.tax, d=sub*(parseInt(document.getElementById('pay-discount-pct').value)||0)/100, f=sub-d; document.getElementById('pay-final-total').innerText=f.toFixed(2); if(document.getElementById('split-check').checked) document.getElementById('split-amount').innerText=`(${(f/(parseInt(document.getElementById('split-count').value)||1)).toFixed(2)})`;}
        function toggleSplit() { const s=document.getElementById('split-check').checked; document.getElementById('split-count').classList.toggle('hidden',!s); document.getElementById('split-amount').classList.toggle('hidden',!s); if(s)updatePaymentTotals(); }
        function processPayment(m){const o=systemOrders.find(x=>x.id===currentPayOrderId); if(o){o.status='paid';o.finalTotal=parseFloat(document.getElementById('pay-final-total').innerText); saveData(); closeModal('payment-modal'); if(!document.getElementById('system-view').classList.contains('hidden'))renderSystemOrders(); if(!document.getElementById('delivery-view').classList.contains('hidden'))renderDeliveryOrders(); printInvoice(o.id);}}
        function printKitchenTicket(id){const o=systemOrders.find(x=>x.id===id); if(!o)return; const h=o.items.map(i=>`<div>${i.qty}x ${i.name} ${i.method||''}</div>`).join(''); document.getElementById('print-area').innerHTML=`<div style="width:80mm;text-align:center"><h2>مطبخ</h2><h1>${o.table}</h1>${h}</div>`; window.print();}
        function printInvoice(id){const o=systemOrders.find(x=>x.id===id); if(!o)return; const h=o.items.map(i=>`<tr><td>${i.name}</td><td>${i.qty}</td><td>${(i.price*i.qty).toFixed(2)}</td></tr>`).join(''); document.getElementById('print-area').innerHTML=`<div style="width:80mm;text-align:center;font-family:'Cairo'"><h2>مطعم حكاية</h2><p>#${o.id.toString().slice(-4)}</p><table>${h}</table><h3>${o.finalTotal.toFixed(2)}</h3></div>`; window.print();}
        function showNotification(m,t='success'){const e=document.getElementById('notification'); document.getElementById('notif-text').innerText=m; e.classList.remove('translate-y-32'); setTimeout(()=>e.classList.add('translate-y-32'),3000);}
        async function callGemini(p){try{const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:p}]}]})});const d=await r.json();return d.candidates[0].content.parts[0].text;}catch(e){return null;}}
        async function getSmartSuggestions(){if(cart.length===0)return showNotification('فارغة','error');document.getElementById('ai-modal').classList.remove('hidden'); document.getElementById('ai-content').innerText='جاري التحليل...'; const res=await callGemini(`Suggest 2 items from ${JSON.stringify(menuItems.map(i=>i.name))} not in ${cart.map(i=>i.name)}. JSON array.`); if(res) document.getElementById('ai-content').innerText=res; else document.getElementById('ai-content').innerText='فشل الاتصال بالخدمة الذكية';}
        async function generateMarketingPost(){document.getElementById('marketing-modal').classList.remove('hidden'); document.getElementById('marketing-content').innerText='جاري التوليد...'; const res=await callGemini('Write arabic post for seafood restaurant'); if(res) document.getElementById('marketing-content').innerText=res; else document.getElementById('marketing-content').innerText='فشل الاتصال بالخدمة الذكية';}
        function closeAiModal(){document.getElementById('ai-modal').classList.add('hidden');}
        function copyToClipboard(){navigator.clipboard.writeText(document.getElementById('marketing-content').innerText); showNotification('تم النسخ');}
    </script>
</body>
</html>
