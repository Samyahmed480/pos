<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام مطعم حكاية | Hekaya POS</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f8fafc;
            height: 100vh;
            overflow: hidden;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* UI Utilities */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .category-btn.active {
            background: linear-gradient(135deg, #0284c7 0%, #0ea5e9 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.3);
            transform: translateY(-1px);
        }

        .item-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: #38bdf8;
        }

        /* Modal Animation */
        .modal-enter { animation: modalIn 0.3s ease-out forwards; }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10B981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10B981;
        }

        /* Loading Spinner */
        .ai-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Print Styles */
        @media print {
            @page { size: auto; margin: 0; }
            body { background: white; margin: 0; }
            body > * { display: none !important; }
            #print-area {
                display: block !important;
                position: absolute;
                left: 0; top: 0; width: 100%;
                background: white; direction: rtl;
            }
            #print-area * { visibility: visible; }
        }
    </style>
</head>
<body class="flex flex-col h-screen text-slate-800">

    <!-- ================= LOGIN SCREEN ================= -->
    <div id="login-screen" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md border-4 border-slate-800 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-sky-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 -translate-y-1/2 translate-x-1/2"></div>
            <div class="absolute bottom-0 left-0 w-32 h-32 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 translate-y-1/2 -translate-x-1/2"></div>
            
            <div class="text-center mb-8 relative z-10">
                <div class="w-20 h-20 bg-gradient-to-br from-sky-500 to-blue-700 rounded-2xl flex items-center justify-center shadow-lg mx-auto mb-4 transform rotate-3">
                    <i class="fas fa-fish text-4xl text-white"></i>
                </div>
                <h1 class="text-3xl font-black text-slate-800">مطعم حكاية</h1>
                <p class="text-slate-500">نظام إدارة المطاعم الذكي</p>
            </div>

            <form onsubmit="handleLogin(event)" class="space-y-5 relative z-10">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">البريد الإلكتروني</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <i class="fas fa-envelope text-slate-400"></i>
                        </div>
                        <input type="email" id="login-email" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block w-full pr-10 p-2.5" placeholder="name@hekaya.com" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">كلمة المرور</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <i class="fas fa-lock text-slate-400"></i>
                        </div>
                        <input type="password" id="login-password" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block w-full pr-10 p-2.5" placeholder="••••••••" required>
                    </div>
                </div>
                <button type="submit" class="w-full text-white bg-gradient-to-r from-sky-500 to-blue-600 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-blue-300 font-bold rounded-lg text-sm px-5 py-3 text-center shadow-lg transform transition hover:-translate-y-1">
                    تسجيل الدخول
                </button>
            </form>
            <div id="login-error" class="mt-4 text-center text-red-500 text-sm font-bold hidden">
                بيانات الدخول غير صحيحة!
            </div>
        </div>
    </div>

    <!-- ================= MAIN APP LAYOUT (Hidden initially) ================= -->
    <div id="main-app" class="flex flex-col h-screen hidden">
        <!-- Top Navigation -->
        <nav class="bg-slate-900 text-white p-3 shadow-xl z-50 relative">
            <div class="container mx-auto flex justify-between items-center relative z-10">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-gradient-to-br from-sky-400 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-fish text-xl text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-black tracking-tight">مطعم حكاية</h1>
                        <p class="text-[10px] text-sky-200 font-medium" id="user-display-name">مرحباً، المستخدم</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <div class="bg-slate-800/80 p-1 rounded-xl flex shadow-inner border border-slate-700/50 overflow-x-auto gap-1">
                        <button onclick="switchView('waiter')" id="btn-waiter" class="nav-btn hidden flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700/50">
                            <i class="fas fa-tablet-alt"></i> النادل
                        </button>
                        <button onclick="switchView('system')" id="btn-system" class="nav-btn hidden flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700/50">
                            <i class="fas fa-desktop"></i> الكاشير
                        </button>
                        <button onclick="switchView('delivery')" id="btn-delivery" class="nav-btn hidden flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700/50">
                            <i class="fas fa-motorcycle"></i> الدليفري
                        </button>
                        <button onclick="switchView('transactions')" id="btn-transactions" class="nav-btn hidden flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700/50">
                            <i class="fas fa-file-invoice"></i> الفواتير
                        </button>
                        <button onclick="switchView('reports')" id="btn-reports" class="nav-btn hidden flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700/50">
                            <i class="fas fa-chart-pie"></i> التقارير
                        </button>
                        <button onclick="switchView('admin')" id="btn-admin" class="nav-btn hidden flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700/50 border-r border-slate-600 mr-2 pr-2">
                            <i class="fas fa-database"></i> البيانات
                        </button>
                    </div>
                    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg text-xs font-bold transition ml-2 shadow-md">
                        <i class="fas fa-sign-out-alt"></i> خروج
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 overflow-hidden relative">

            <!-- WAITER VIEW -->
            <div id="waiter-view" class="view-section absolute inset-0 flex flex-col transition-all duration-300 hidden">
                <!-- Header -->
                <div class="bg-white/80 backdrop-blur-md border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm z-20">
                    <div class="flex items-center gap-4 bg-slate-100 rounded-lg p-1 pr-4 border border-slate-200">
                        <span class="text-slate-500 font-bold text-sm"><i class="fas fa-chair text-slate-400 ml-2"></i>نوع الطلب:</span>
                        <select id="order-type-select" class="bg-white border-0 text-slate-800 text-sm font-bold rounded-md focus:ring-2 focus:ring-sky-500 block w-40 py-2" onchange="toggleDeliveryFields()">
                            <option value="dine-in">محلي (طاولة)</option>
                            <option value="delivery">دليفري (توصيل)</option>
                        </select>
                    </div>
                    <div id="table-select-wrapper" class="flex items-center gap-2">
                        <span class="text-slate-500 font-bold text-sm">رقم الطاولة:</span>
                        <select id="table-select" class="bg-white border border-slate-300 text-slate-800 text-sm font-bold rounded-md py-1 px-2"></select>
                    </div>
                    <div id="delivery-fields" class="hidden flex items-center gap-2">
                        <input type="text" id="cust-name" placeholder="اسم العميل" class="bg-white border border-slate-300 rounded px-2 py-1 text-sm w-32">
                        <input type="text" id="cust-phone" placeholder="رقم الهاتف" class="bg-white border border-slate-300 rounded px-2 py-1 text-sm w-32">
                        <input type="text" id="cust-address" placeholder="العنوان" class="bg-white border border-slate-300 rounded px-2 py-1 text-sm w-48">
                    </div>
                    <div class="flex items-center gap-2 bg-sky-50 text-sky-700 px-4 py-2 rounded-lg border border-sky-100">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="font-bold text-sm">متصل</span>
                    </div>
                </div>
                <div class="flex flex-1 overflow-hidden">
                    <!-- Menu -->
                    <div class="flex-1 flex flex-col relative">
                        <div class="p-4 bg-white/50 border-b border-slate-200 flex gap-3 overflow-x-auto scrollbar-hide">
                            <button onclick="filterMenu('all')" class="category-btn active px-6 py-3 rounded-xl font-bold bg-white border border-slate-200 shadow-sm">الكل</button>
                            <button onclick="filterMenu('fish')" class="category-btn px-6 py-3 rounded-xl font-bold bg-white border border-slate-200 shadow-sm">أسماك</button>
                            <button onclick="filterMenu('shrimp')" class="category-btn px-6 py-3 rounded-xl font-bold bg-white border border-slate-200 shadow-sm">جمبري</button>
                            <button onclick="filterMenu('sides')" class="category-btn px-6 py-3 rounded-xl font-bold bg-white border border-slate-200 shadow-sm">جانبي</button>
                            <button onclick="filterMenu('drinks')" class="category-btn px-6 py-3 rounded-xl font-bold bg-white border border-slate-200 shadow-sm">مشروبات</button>
                        </div>
                        <div id="menu-grid" class="p-6 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-5 overflow-y-auto pb-24"></div>
                    </div>
                    <!-- Cart -->
                    <div class="w-96 bg-white/95 backdrop-blur shadow-2xl z-30 flex flex-col border-r border-slate-200">
                        <div class="p-5 bg-gradient-to-l from-slate-50 to-white border-b border-slate-100">
                            <h2 class="font-extrabold text-xl text-slate-800 flex items-center gap-2">
                                <i class="fas fa-receipt text-sky-500"></i> الطلب الحالي
                            </h2>
                        </div>
                        <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/50"></div>
                        <div class="px-5 pt-2">
                            <button onclick="getSmartSuggestions()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-600 text-white font-bold py-2 rounded-lg shadow-md hover:from-violet-600 hover:to-fuchsia-700 transition flex items-center justify-center gap-2 text-sm border border-fuchsia-400/50">
                                <i class="fas fa-sparkles text-yellow-300"></i> اقتراحات ذكية (AI)
                            </button>
                        </div>
                        <div class="p-5 bg-white border-t border-slate-200">
                            <div class="flex justify-between items-center mb-6 text-xl font-black text-slate-800">
                                <span>الإجمالي التقديري:</span>
                                <span id="cart-total" class="text-sky-600">0.00 ر.س</span>
                            </div>
                            <button onclick="submitOrder()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg transition flex justify-center items-center gap-3">
                                <span>إرسال للمطبخ</span> <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SYSTEM VIEW -->
            <div id="system-view" class="view-section absolute inset-0 flex flex-col bg-slate-100/50 hidden opacity-0 transition-opacity duration-300">
                <div class="p-6 flex-1 overflow-y-auto">
                    <div class="flex justify-between items-end mb-8">
                        <h2 class="text-3xl font-black text-slate-800">شاشة الكاشير والمطبخ (محلي)</h2>
                        <div class="flex gap-4">
                            <div class="bg-white px-6 py-3 rounded-xl shadow-sm border border-slate-200 text-center">
                                <span class="text-xs font-bold text-slate-400">المبيعات</span>
                                <span id="stats-revenue" class="block font-black text-2xl text-emerald-600">0 ر.س</span>
                            </div>
                        </div>
                    </div>
                    <div id="no-orders-msg" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
                        <i class="fas fa-clipboard-list text-5xl mb-4 text-slate-200"></i>
                        <h3>لا توجد طلبات نشطة</h3>
                    </div>
                    <div id="orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 relative z-10"></div>
                </div>
            </div>

            <!-- DELIVERY VIEW -->
            <div id="delivery-view" class="view-section absolute inset-0 flex flex-col bg-slate-100/50 hidden opacity-0 transition-opacity duration-300">
                <div class="p-6 flex-1 overflow-y-auto">
                    <h2 class="text-3xl font-black text-slate-800 mb-6"><i class="fas fa-motorcycle text-orange-500 ml-2"></i>إدارة طلبات الدليفري</h2>
                    <div class="grid grid-cols-3 gap-6 h-[80vh]">
                        <div class="bg-white rounded-2xl shadow p-4 flex flex-col"><h3 class="font-bold text-lg mb-4 text-slate-700 border-b pb-2">جاري التحضير <span id="count-prep" class="bg-slate-200 px-2 rounded-full text-xs">0</span></h3><div id="delivery-prep" class="flex-1 overflow-y-auto space-y-3"></div></div>
                        <div class="bg-white rounded-2xl shadow p-4 flex flex-col"><h3 class="font-bold text-lg mb-4 text-orange-600 border-b pb-2">خرج للتوصيل <span id="count-out" class="bg-orange-100 px-2 rounded-full text-xs">0</span></h3><div id="delivery-out" class="flex-1 overflow-y-auto space-y-3"></div></div>
                        <div class="bg-white rounded-2xl shadow p-4 flex flex-col"><h3 class="font-bold text-lg mb-4 text-green-600 border-b pb-2">تم التسليم <span id="count-done" class="bg-green-100 px-2 rounded-full text-xs">0</span></h3><div id="delivery-done" class="flex-1 overflow-y-auto space-y-3"></div></div>
                    </div>
                </div>
            </div>

            <!-- TRANSACTIONS VIEW -->
            <div id="transactions-view" class="view-section absolute inset-0 flex flex-col bg-slate-100/50 hidden opacity-0 transition-opacity duration-300">
                <div class="p-8 max-w-6xl mx-auto w-full h-full overflow-y-auto">
                    <h2 class="text-3xl font-black text-slate-800 mb-6"><i class="fas fa-history text-slate-500 ml-2"></i>سجل الفواتير والمرتجعات</h2>
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                        <table class="w-full text-sm text-right text-slate-600">
                            <thead class="bg-slate-50 text-slate-700 uppercase font-bold"><tr><th class="px-6 py-4">رقم الفاتورة</th><th class="px-6 py-4">النوع / الطاولة</th><th class="px-6 py-4">الوقت</th><th class="px-6 py-4">الإجمالي</th><th class="px-6 py-4">الحالة</th><th class="px-6 py-4 text-center">إجراءات</th></tr></thead>
                            <tbody id="transactions-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- REPORTS VIEW -->
            <div id="reports-view" class="view-section absolute inset-0 flex flex-col bg-slate-100/50 hidden opacity-0 transition-opacity duration-300">
                <div class="p-8 max-w-6xl mx-auto w-full h-full overflow-y-auto">
                    <h2 class="text-3xl font-black text-slate-800 mb-6"><i class="fas fa-chart-pie text-purple-500 ml-2"></i>التقارير والإحصائيات</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-2xl shadow border-r-4 border-blue-500"><p class="text-slate-500 font-bold text-xs uppercase">إجمالي المبيعات</p><p id="report-total-sales" class="text-2xl font-black text-slate-800 mt-2">0 ر.س</p></div>
                        <div class="bg-white p-6 rounded-2xl shadow border-r-4 border-green-500"><p class="text-slate-500 font-bold text-xs uppercase">عدد الطلبات المكتملة</p><p id="report-total-orders" class="text-2xl font-black text-slate-800 mt-2">0</p></div>
                        <div class="bg-white p-6 rounded-2xl shadow border-r-4 border-red-500"><p class="text-slate-500 font-bold text-xs uppercase">الفواتير الملغاة</p><p id="report-cancelled" class="text-2xl font-black text-slate-800 mt-2">0</p></div>
                        <div class="bg-white p-6 rounded-2xl shadow border-r-4 border-orange-500"><p class="text-slate-500 font-bold text-xs uppercase">أكثر صنف مبيعاً</p><p id="report-top-item" class="text-lg font-bold text-slate-800 mt-2">-</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow mb-8"><h3 class="font-bold text-lg mb-6 text-slate-800">تحليل المبيعات حسب الفئة</h3><div class="space-y-6" id="category-bars"></div></div>
                </div>
            </div>

            <!-- ADMIN VIEW (DATA CONTROL) -->
            <div id="admin-view" class="view-section absolute inset-0 flex flex-col bg-slate-100 hidden opacity-0 transition-opacity duration-300">
                <div class="p-8 max-w-6xl mx-auto w-full h-full overflow-y-auto">
                    <!-- Tabs for Admin -->
                    <div class="flex gap-4 mb-6 border-b pb-2">
                        <button onclick="switchAdminTab('data')" id="tab-data" class="admin-tab-btn px-4 py-2 font-bold text-sky-600 border-b-2 border-sky-600">إدارة البيانات والأصناف</button>
                        <button onclick="switchAdminTab('users')" id="tab-users" class="admin-tab-btn px-4 py-2 font-bold text-slate-500 hover:text-sky-600">إدارة المستخدمين والصلاحيات</button>
                    </div>

                    <!-- DATA TAB CONTENT -->
                    <div id="admin-content-data">
                        <div class="flex justify-between items-center mb-8">
                            <div><h2 class="text-2xl font-black text-slate-800 mb-2">قائمة الأصناف</h2><p class="text-slate-500">إدارة الأصناف، المخزون، والأسعار.</p></div>
                            <div class="flex gap-2">
                                <button onclick="openAddItemModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg shadow-md font-bold flex items-center gap-2 transition"><i class="fas fa-plus-circle"></i> إضافة صنف</button>
                                <button onclick="generateMarketingPost()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow-md font-bold flex items-center gap-2 transition"><i class="fas fa-bullhorn"></i> ✨ توليد إعلان</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-md p-6 mb-8 flex items-center justify-between">
                            <div><h3 class="font-bold text-lg text-slate-800 mb-1">إعدادات المطعم</h3><p class="text-sm text-slate-500">عدد الطاولات المتاحة.</p></div>
                            <div class="flex items-center gap-2"><label class="font-bold text-sm">عدد الطاولات:</label><input type="number" id="settings-table-count" class="w-20 border rounded p-2 text-center" min="1" max="100"><button onclick="saveTableSettings()" class="bg-sky-500 text-white px-4 py-2 rounded hover:bg-sky-600 font-bold text-sm">حفظ</button></div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-8"><table class="w-full text-sm text-right text-slate-600"><thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b"><tr><th class="px-6 py-4">الصنف</th><th class="px-6 py-4">الفئة</th><th class="px-6 py-4">السعر (ر.س)</th><th class="px-6 py-4">الحالة (Stock)</th><th class="px-6 py-4 text-center">تحديث</th></tr></thead><tbody id="admin-table-body"></tbody></table></div>
                    </div>

                    <!-- USERS TAB CONTENT -->
                    <div id="admin-content-users" class="hidden">
                        <div class="flex justify-between items-center mb-8">
                            <div><h2 class="text-2xl font-black text-slate-800 mb-2">المستخدمين والصلاحيات</h2><p class="text-slate-500">إضافة مستخدمين وتحديد الصفحات المسموحة.</p></div>
                            <button onclick="openAddUserModal()" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-lg shadow-md font-bold flex items-center gap-2 transition"><i class="fas fa-user-plus"></i> مستخدم جديد</button>
                        </div>
                        <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-8">
                            <table class="w-full text-sm text-right text-slate-600">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b">
                                    <tr>
                                        <th class="px-6 py-4">الاسم</th>
                                        <th class="px-6 py-4">البريد الإلكتروني</th>
                                        <th class="px-6 py-4">الصلاحيات (الصفحات)</th>
                                        <th class="px-6 py-4 text-center">حذف</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODALS (Keep existing ones, Add User Modal) -->
    <!-- Customization Modal -->
    <div id="custom-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] hidden flex items-center justify-center">
        <!-- (Same as before) -->
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="bg-slate-900 text-white p-4 flex justify-between items-center"><h3 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-utensils"></i> <span id="modal-item-name">تخصيص الصنف</span></h3><button onclick="closeModal('custom-modal')" class="text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button></div>
            <div class="p-6 space-y-6">
                <div><label class="block text-sm font-bold text-slate-700 mb-2" id="qty-label">الوزن</label><div class="flex items-center gap-2"><button onclick="adjustModalQty(-0.25)" class="w-10 h-10 bg-slate-100 rounded-lg font-bold">-</button><input type="number" id="modal-qty" class="flex-1 bg-slate-50 border rounded-lg p-2 text-center font-bold text-lg" value="1.0" step="0.1"><button onclick="adjustModalQty(0.25)" class="w-10 h-10 bg-slate-100 rounded-lg font-bold">+</button></div></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-2">طريقة الطهي</label><div class="grid grid-cols-2 gap-3" id="cooking-options"></div></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-2">ملاحظات</label><textarea id="modal-notes" class="w-full bg-slate-50 border rounded-lg p-2 text-sm" rows="2"></textarea></div>
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-end gap-3"><button onclick="closeModal('custom-modal')" class="px-4 py-2 font-bold rounded-lg hover:bg-slate-200">إلغاء</button><button onclick="confirmCustomization()" class="px-6 py-2 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700">إضافة</button></div>
        </div>
    </div>

    <!-- Add Item Modal (Same as before) -->
    <div id="add-item-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[65] hidden flex items-center justify-center">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="bg-emerald-600 text-white p-4 flex justify-between items-center"><h3 class="font-bold text-lg">إضافة صنف</h3><button onclick="closeModal('add-item-modal')" class="text-white/80 hover:text-white"><i class="fas fa-times text-xl"></i></button></div>
            <div class="p-6 space-y-4">
                <div><label class="block text-sm font-bold text-slate-700 mb-1">الاسم</label><input type="text" id="new-item-name" class="w-full border rounded p-2"></div>
                <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-bold text-slate-700 mb-1">السعر</label><input type="number" id="new-item-price" class="w-full border rounded p-2"></div><div><label class="block text-sm font-bold text-slate-700 mb-1">الوحدة</label><select id="new-item-type" class="w-full border rounded p-2"><option value="unit">عدد</option><option value="weight">وزن</option></select></div></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">الفئة</label><select id="new-item-category" class="w-full border rounded p-2"><option value="fish">أسماك</option><option value="shrimp">جمبري</option><option value="sides">جانبي</option><option value="drinks">مشروبات</option></select></div>
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-end gap-3"><button onclick="closeModal('add-item-modal')" class="px-4 py-2 font-bold hover:bg-slate-200 rounded-lg">إلغاء</button><button onclick="saveNewItem()" class="px-6 py-2 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700">حفظ</button></div>
        </div>
    </div>

    <!-- ADD USER MODAL -->
    <div id="add-user-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[75] hidden flex items-center justify-center">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="bg-slate-800 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-user-plus"></i> مستخدم جديد</h3>
                <button onclick="closeModal('add-user-modal')" class="text-white/80 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-bold text-slate-700 mb-1">الاسم</label><input type="text" id="new-user-name" class="w-full border rounded p-2"></div>
                    <div><label class="block text-sm font-bold text-slate-700 mb-1">كلمة المرور</label><input type="text" id="new-user-pass" class="w-full border rounded p-2"></div>
                </div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">البريد الإلكتروني</label><input type="email" id="new-user-email" class="w-full border rounded p-2"></div>
                
                <div class="border-t pt-4 mt-2">
                    <label class="block text-sm font-bold text-slate-700 mb-3">صلاحيات الوصول للصفحات:</label>
                    <div class="grid grid-cols-2 gap-3" id="permissions-list">
                        <label class="flex items-center space-x-2 space-x-reverse"><input type="checkbox" value="waiter" class="perm-check w-4 h-4 text-sky-600"> <span>تابلت النادل</span></label>
                        <label class="flex items-center space-x-2 space-x-reverse"><input type="checkbox" value="system" class="perm-check w-4 h-4 text-sky-600"> <span>الكاشير والمطبخ</span></label>
                        <label class="flex items-center space-x-2 space-x-reverse"><input type="checkbox" value="delivery" class="perm-check w-4 h-4 text-sky-600"> <span>الدليفري</span></label>
                        <label class="flex items-center space-x-2 space-x-reverse"><input type="checkbox" value="transactions" class="perm-check w-4 h-4 text-sky-600"> <span>سجل الفواتير</span></label>
                        <label class="flex items-center space-x-2 space-x-reverse"><input type="checkbox" value="reports" class="perm-check w-4 h-4 text-sky-600"> <span>التقارير</span></label>
                        <label class="flex items-center space-x-2 space-x-reverse"><input type="checkbox" value="admin" class="perm-check w-4 h-4 text-sky-600"> <span>إدارة البيانات (Admin)</span></label>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-end gap-3">
                <button onclick="closeModal('add-user-modal')" class="px-4 py-2 font-bold hover:bg-slate-200 rounded-lg">إلغاء</button>
                <button onclick="saveNewUser()" class="px-6 py-2 bg-slate-800 text-white font-bold rounded-lg hover:bg-slate-900">إنشاء المستخدم</button>
            </div>
        </div>
    </div>

    <!-- AI/Marketing/Payment Modals (Same as before) -->
    <div id="ai-modal" class="hidden fixed inset-0 bg-black/60 z-[70] flex items-center justify-center"><div class="bg-white w-full max-w-md rounded-2xl p-0 overflow-hidden"><div class="bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white p-4 flex justify-between"><h3 class="font-bold">مساعد ذكي</h3><button onclick="closeAiModal()" class="text-white"><i class="fas fa-times"></i></button></div><div id="ai-content" class="p-6"></div></div></div>
    <div id="marketing-modal" class="hidden fixed inset-0 bg-black/60 z-[70] flex items-center justify-center"><div class="bg-white w-full max-w-lg rounded-2xl overflow-hidden"><div class="bg-indigo-600 text-white p-4 flex justify-between"><h3 class="font-bold">إعلان AI</h3><button onclick="document.getElementById('marketing-modal').classList.add('hidden')" class="text-white"><i class="fas fa-times"></i></button></div><div id="marketing-content" class="p-6"></div><div class="p-4 bg-slate-100 border-t flex justify-end"><button onclick="copyToClipboard()" class="text-indigo-600 font-bold">نسخ</button></div></div></div>
    <div id="payment-modal" class="hidden fixed inset-0 bg-black/60 z-[60] flex items-center justify-center"><div class="bg-white w-full max-w-md rounded-2xl overflow-hidden"><div class="bg-emerald-700 text-white p-4"><h3 class="font-bold text-center">دفع</h3></div><div class="p-6 space-y-4"><div class="flex justify-between"><span>المبلغ</span><span id="pay-subtotal" class="font-bold"></span></div><div class="flex justify-between"><span>الضريبة</span><span id="pay-tax" class="font-bold"></span></div><div class="bg-amber-50 p-2 rounded flex justify-between items-center"><label class="text-xs font-bold">خصم %</label><input type="number" id="pay-discount-pct" class="w-12 border text-center" onchange="updatePaymentTotals()"></div><div class="flex justify-between text-xl font-bold"><span>الإجمالي</span><span id="pay-final-total"></span></div><div class="flex items-center gap-2"><input type="checkbox" id="split-check" onchange="toggleSplit()"><span>تقسيم</span><input type="number" id="split-count" class="hidden w-12 border text-center" value="2" onchange="updatePaymentTotals()"><span id="split-amount" class="text-xs font-bold text-sky-600"></span></div><div class="grid grid-cols-3 gap-2"><button onclick="processPayment('CASH')" class="border p-2 rounded hover:bg-green-50">كاش</button><button onclick="processPayment('CARD')" class="border p-2 rounded hover:bg-blue-50">بطاقة</button><button onclick="processPayment('APPLE')" class="border p-2 rounded hover:bg-gray-50">Apple</button></div></div><div class="bg-gray-50 p-2 text-center"><button onclick="closeModal('payment-modal')" class="text-red-500 text-sm font-bold">إلغاء</button></div></div></div>

    <div id="print-area" class="hidden"></div>
    <div id="notification" class="fixed bottom-6 left-6 bg-slate-800 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-32 transition-transform duration-500 z-[70] flex items-center gap-4">
        <div class="w-8 h-8 rounded-full bg-emerald-500 flex items-center justify-center flex-shrink-0"><i class="fas fa-check text-white text-sm"></i></div>
        <div><h4 class="font-bold text-sm">تم بنجاح</h4><p id="notif-text" class="text-xs text-slate-300 mt-0.5">...</p></div>
    </div>

    <script>
        const apiKey = ""; 
        let tablesCount = 6;
        let menuItems = [
            { id: 1, name: "جمبري جامبو", price: 160, category: "shrimp", type: "weight", icon: "fa-shrimp", color: "text-orange-500", inStock: true },
            { id: 2, name: "استاكوزا", price: 220, category: "shrimp", type: "weight", icon: "fa-spider", color: "text-red-600", inStock: true },
            { id: 3, name: "سمك دنيس", price: 55, category: "fish", type: "weight", icon: "fa-fish", color: "text-blue-500", inStock: true },
            { id: 4, name: "سمك قاروص", price: 70, category: "fish", type: "weight", icon: "fa-fish", color: "text-blue-600", inStock: true },
            { id: 5, name: "فيليه هامور", price: 45, category: "fish", type: "unit", icon: "fa-utensils", color: "text-yellow-600", inStock: true },
            { id: 6, name: "طاجن سي فود", price: 60, category: "fish", type: "unit", icon: "fa-bowl-food", color: "text-orange-700", inStock: true },
            { id: 7, name: "كابوريا", price: 50, category: "shrimp", type: "weight", icon: "fa-certificate", color: "text-red-500", inStock: true },
            { id: 8, name: "أرز صيادية", price: 15, category: "sides", type: "unit", icon: "fa-bowl-rice", color: "text-amber-700", inStock: true },
            { id: 9, name: "سلطة طحينة", price: 8, category: "sides", type: "unit", icon: "fa-lemon", color: "text-yellow-500", inStock: true },
            { id: 10, name: "شوربة سي فود", price: 35, category: "shrimp", type: "unit", icon: "fa-mug-hot", color: "text-orange-400", inStock: true },
            { id: 11, name: "بيبسي", price: 5, category: "drinks", type: "unit", icon: "fa-bottle-water", color: "text-blue-800", inStock: true },
            { id: 12, name: "عصير ليمون", price: 12, category: "drinks", type: "unit", icon: "fa-glass-water", color: "text-green-500", inStock: true }
        ];
        const cookingMethods = [{id:'grilled_oil',name:'مشوي زيت وليمون'},{id:'grilled_rada',name:'مشوي ردة'},{id:'singari',name:'سنجاري'},{id:'fried',name:'مقلي'},{id:'tagine',name:'طاجن'},{id:'butterfly',name:'باترفلاي'}];
        
        let cart = [], systemOrders = [], currentModalItem = null, currentPayOrderId = null;
        const VAT_RATE = 0.15;

        // --- AUTH & USERS SYSTEM ---
        let currentUser = null;
        // Default Users
        let users = [
            { id: 1, name: "المدير العام", email: "admin@hekaya.com", pass: "123456", perms: ['waiter','system','delivery','transactions','reports','admin'] },
            { id: 2, name: "نادل 1", email: "waiter@hekaya.com", pass: "123456", perms: ['waiter'] },
            { id: 3, name: "كاشير", email: "cashier@hekaya.com", pass: "123456", perms: ['system','transactions'] }
        ];

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            
            const user = users.find(u => u.email === email && u.pass === pass);
            
            if(user) {
                currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('user-display-name').innerText = `مرحباً، ${user.name}`;
                updateNavBasedOnPerms();
                
                // Route to first available view
                if(user.perms.includes('admin')) switchView('admin');
                else switchView(user.perms[0]);
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-error').classList.add('hidden');
        }

        function updateNavBasedOnPerms() {
            const btns = ['waiter', 'system', 'delivery', 'transactions', 'reports', 'admin'];
            btns.forEach(view => {
                const btn = document.getElementById(`btn-${view}`);
                if(currentUser.perms.includes(view)) {
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            });
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderMenu('all');
            initTables();
            document.getElementById('settings-table-count').value = tablesCount;
        });

        // --- NAVIGATION ---
        function switchView(viewName) {
            if(!currentUser.perms.includes(viewName)) {
                showNotification('ليس لديك صلاحية الوصول لهذه الصفحة', 'error');
                return;
            }

            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden', 'opacity-0'));
            document.querySelectorAll('.nav-btn').forEach(el => el.className = el.className.replace('bg-sky-500 text-white shadow-lg', 'text-slate-400 hover:text-white hover:bg-slate-700/50'));

            const view = document.getElementById(viewName + '-view');
            const btn = document.getElementById('btn-' + viewName);
            
            if(view) { view.classList.remove('hidden'); setTimeout(() => view.classList.remove('opacity-0'), 50); }
            if(btn) btn.className = "nav-btn flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold transition-all bg-sky-500 text-white shadow-lg";

            if (viewName === 'system') renderSystemOrders();
            if (viewName === 'delivery') renderDeliveryOrders();
            if (viewName === 'transactions') renderTransactions();
            if (viewName === 'reports') renderReports();
            if (viewName === 'admin') {
                renderAdminTable();
                renderUsersTable();
            }
        }

        // --- ADMIN TABS ---
        function switchAdminTab(tab) {
            document.getElementById('admin-content-data').classList.add('hidden');
            document.getElementById('admin-content-users').classList.add('hidden');
            
            document.getElementById('tab-data').className = "admin-tab-btn px-4 py-2 font-bold text-slate-500 hover:text-sky-600";
            document.getElementById('tab-users').className = "admin-tab-btn px-4 py-2 font-bold text-slate-500 hover:text-sky-600";

            document.getElementById(`admin-content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).className = "admin-tab-btn px-4 py-2 font-bold text-sky-600 border-b-2 border-sky-600";
        }

        // --- USER MANAGEMENT ---
        function renderUsersTable() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            users.forEach(u => {
                const permsBadges = u.perms.map(p => `<span class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded mx-1">${p}</span>`).join('');
                tbody.innerHTML += `
                    <tr class="bg-white border-b hover:bg-slate-50">
                        <td class="px-6 py-4 font-bold text-slate-900">${u.name}</td>
                        <td class="px-6 py-4">${u.email}</td>
                        <td class="px-6 py-4">${permsBadges}</td>
                        <td class="px-6 py-4 text-center">
                            ${u.id !== 1 ? `<button onclick="deleteUser(${u.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>` : '<span class="text-gray-400 text-xs">لا يمكن حذفه</span>'}
                        </td>
                    </tr>
                `;
            });
        }

        function openAddUserModal() {
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-email').value = '';
            document.getElementById('new-user-pass').value = '';
            document.querySelectorAll('.perm-check').forEach(c => c.checked = false);
            document.getElementById('add-user-modal').classList.remove('hidden');
        }

        function saveNewUser() {
            const name = document.getElementById('new-user-name').value;
            const email = document.getElementById('new-user-email').value;
            const pass = document.getElementById('new-user-pass').value;
            const perms = Array.from(document.querySelectorAll('.perm-check:checked')).map(c => c.value);

            if(!name || !email || !pass || perms.length === 0) {
                showNotification('يرجى ملء كافة البيانات واختيار صلاحية واحدة على الأقل', 'error');
                return;
            }

            users.push({ id: Date.now(), name, email, pass, perms });
            renderUsersTable();
            closeModal('add-user-modal');
            showNotification('تم إضافة المستخدم بنجاح');
        }

        function deleteUser(id) {
            if(confirm('حذف المستخدم؟')) {
                users = users.filter(u => u.id !== id);
                renderUsersTable();
            }
        }

        // --- SHARED FUNCTIONS (Menu, Cart, Orders) ---
        function initTables() {
            const select = document.getElementById('table-select');
            select.innerHTML = '';
            for(let i=1; i<=tablesCount; i++) {
                const opt = document.createElement('option');
                opt.value = i; opt.text = i + (i === 6 ? ' (VIP)' : '');
                select.appendChild(opt);
            }
        }
        function saveTableSettings() {
            const count = parseInt(document.getElementById('settings-table-count').value);
            if(count && count > 0) { tablesCount = count; initTables(); showNotification('تم التحديث'); }
        }
        function toggleDeliveryFields() {
            const type = document.getElementById('order-type-select').value;
            if (type === 'delivery') {
                document.getElementById('table-select-wrapper').classList.add('hidden');
                document.getElementById('delivery-fields').classList.remove('hidden');
                document.getElementById('delivery-fields').classList.add('flex');
            } else {
                document.getElementById('table-select-wrapper').classList.remove('hidden');
                document.getElementById('delivery-fields').classList.add('hidden');
                document.getElementById('delivery-fields').classList.remove('flex');
            }
        }
        function filterMenu(category) {
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderMenu(category);
        }
        function renderMenu(category) {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';
            const filtered = category === 'all' ? menuItems : menuItems.filter(i => i.category === category);
            filtered.forEach(item => {
                const opacity = item.inStock ? 'opacity-100' : 'opacity-50 grayscale pointer-events-none';
                const div = document.createElement('div');
                div.className = `item-card bg-white p-5 rounded-2xl shadow-sm border border-slate-100 cursor-pointer flex flex-col items-center text-center h-full justify-between group ${opacity}`;
                div.onclick = () => item.inStock && handleItemClick(item);
                div.innerHTML = `<div class="mb-4 w-16 h-16 rounded-full bg-slate-50 flex items-center justify-center text-3xl ${item.color} shadow-inner"><i class="fas ${item.icon}"></i></div><div class="w-full"><h3 class="font-bold text-slate-800 text-base mb-2">${item.name}</h3><div class="flex justify-center items-center gap-2"><span class="text-sky-600 font-extrabold text-lg">${item.price}</span><span class="text-xs text-slate-400 font-medium">/${item.type==='weight'?'كجم':'قطعة'}</span></div></div>${!item.inStock?'<span class="text-red-500 font-bold text-xs mt-2">نفذت الكمية</span>':''}`;
                grid.appendChild(div);
            });
        }
        function handleItemClick(item) {
            if (item.type === 'weight' || item.category === 'fish' || item.category === 'shrimp') openCustomModal(item); else addToCart(item, 1);
        }
        function openCustomModal(item) {
            currentModalItem = item;
            document.getElementById('modal-item-name').innerText = item.name;
            document.getElementById('qty-label').innerText = item.type === 'weight' ? 'الوزن (كيلوجرام)' : 'العدد';
            document.getElementById('modal-qty').value = "1.0";
            document.getElementById('modal-qty').step = item.type === 'weight' ? "0.1" : "1";
            document.getElementById('modal-notes').value = "";
            const optsContainer = document.getElementById('cooking-options');
            optsContainer.innerHTML = '';
            cookingMethods.forEach((method, index) => {
                const checked = index === 0 ? 'checked' : '';
                optsContainer.innerHTML += `<label class="cursor-pointer border p-2 rounded-lg hover:bg-sky-50 has-[:checked]:bg-sky-100 has-[:checked]:border-sky-500 transition"><input type="radio" name="cookingMethod" value="${method.name}" class="hidden" ${checked}><span class="text-sm font-bold text-slate-700 block text-center">${method.name}</span></label>`;
            });
            document.getElementById('custom-modal').classList.remove('hidden');
        }
        function adjustModalQty(d) { let v = parseFloat(document.getElementById('modal-qty').value)+d; if(v<0.1)v=0.1; document.getElementById('modal-qty').value=v.toFixed(1); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function confirmCustomization() { addToCart(currentModalItem, parseFloat(document.getElementById('modal-qty').value), document.querySelector('input[name="cookingMethod"]:checked').value, document.getElementById('modal-notes').value); closeModal('custom-modal'); }
        function addToCart(item, qty, method=null, notes="") {
            if(method) cart.push({...item, qty, method, notes, cartId: Date.now()});
            else { const ex = cart.find(c=>c.id===item.id&&!c.method); if(ex) ex.qty+=qty; else cart.push({...item, qty, method, notes, cartId: Date.now()}); }
            renderCart(); showNotification('تمت الإضافة للسلة');
        }
        function removeFromCart(id) { cart = cart.filter(c=>c.cartId!==id); renderCart(); }
        function renderCart() {
            const con = document.getElementById('cart-items'); con.innerHTML=''; let total=0;
            cart.forEach(i => {
                total+=i.price*i.qty;
                con.innerHTML += `<div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex justify-between items-start"><div><div class="font-bold text-sm text-slate-800">${i.name} <span class="text-xs text-slate-400">x${i.qty}</span></div>${i.method?`<div class="text-[10px] text-sky-600 mt-1">${i.method} | ${i.notes}</div>`:''}<div class="text-xs font-bold text-slate-500 mt-1">${(i.price*i.qty).toFixed(1)} ر.س</div></div><button onclick="removeFromCart(${i.cartId})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash-alt"></i></button></div>`;
            });
            document.getElementById('cart-total').innerText = total.toFixed(2)+' ر.س';
        }
        function submitOrder() {
            if(cart.length===0) return showNotification('السلة فارغة','error');
            const type = document.getElementById('order-type-select').value;
            const sub = cart.reduce((s,i)=>s+(i.price*i.qty),0);
            let order = { id: Date.now(), type, items: [...cart], subtotal: sub, tax: sub*VAT_RATE, total: sub*1.15, finalTotal: sub*1.15, time: new Date().toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'}), status: 'pending', isCancelled: false };
            if(type==='delivery') { order.customer = {name: document.getElementById('cust-name').value||'عميل', phone: document.getElementById('cust-phone').value||'-', address: document.getElementById('cust-address').value||'-'}; order.table='دليفري'; order.deliveryStatus='preparing'; document.getElementById('cust-name').value=''; } else order.table=document.getElementById('table-select').value;
            systemOrders.unshift(order); cart=[]; renderCart(); showNotification('تم إرسال الطلب');
        }
        function renderSystemOrders() {
            const con=document.getElementById('orders-container'); con.innerHTML='';
            const active=systemOrders.filter(o=>o.type==='dine-in'&&!o.isCancelled);
            if(active.length===0) document.getElementById('no-orders-msg').classList.remove('hidden'); else document.getElementById('no-orders-msg').classList.add('hidden');
            document.getElementById('stats-revenue').innerText = systemOrders.filter(o=>o.status==='paid').reduce((s,o)=>s+o.finalTotal,0).toFixed(0)+' ر.س';
            active.forEach(o=>{
                let items=o.items.map(i=>`<div class="flex justify-between text-xs py-1 border-b last:border-0"><span>${i.qty}x ${i.name}</span><span class="font-bold">${(i.price*i.qty).toFixed(0)}</span></div>`).join('');
                con.innerHTML+=`<div class="bg-white rounded-2xl shadow-lg border overflow-hidden flex flex-col"><div class="p-4 bg-slate-50 flex justify-between border-b"><div><h3 class="font-bold">طاولة ${o.table}</h3><span class="text-xs text-slate-400">#${o.id.toString().slice(-4)}</span></div><span class="px-2 py-1 rounded text-xs font-bold border ${o.status==='paid'?'bg-emerald-100 text-emerald-700':'bg-amber-50 text-amber-600'}">${o.status==='paid'?'مدفوع':'انتظار'}</span></div><div class="p-4 flex-1 overflow-y-auto max-h-40 space-y-1">${items}</div><div class="p-3 bg-slate-50 border-t flex gap-2"><button onclick="printKitchenTicket(${o.id})" class="flex-1 py-2 border rounded bg-white hover:bg-orange-50 text-orange-600 text-xs font-bold">مطبخ</button><button onclick="openPaymentModal(${o.id})" class="flex-1 py-2 border rounded bg-sky-600 hover:bg-sky-700 text-white text-xs font-bold">دفع</button></div></div>`;
            });
        }
        function renderDeliveryOrders() {
            const prep=document.getElementById('delivery-prep'), out=document.getElementById('delivery-out'), done=document.getElementById('delivery-done');
            prep.innerHTML=''; out.innerHTML=''; done.innerHTML='';
            const ords = systemOrders.filter(o=>o.type==='delivery'&&!o.isCancelled);
            let c={preparing:0,out:0,delivered:0};
            ords.forEach(o=>{ c[o.deliveryStatus]++; const card=createDelCard(o); if(o.deliveryStatus==='out')out.appendChild(card); else if(o.deliveryStatus==='delivered')done.appendChild(card); else prep.appendChild(card); });
            document.getElementById('count-prep').innerText=c.preparing; document.getElementById('count-out').innerText=c.out; document.getElementById('count-done').innerText=c.delivered;
        }
        function createDelCard(o) {
            const d=document.createElement('div'); d.className="bg-slate-50 p-3 rounded-xl border text-sm";
            let btn = o.deliveryStatus==='preparing' ? `<button onclick="updDel(${o.id},'out')" class="w-full mt-2 bg-orange-500 text-white py-1 rounded font-bold">خرج للتوصيل</button>` : (o.deliveryStatus==='out' ? `<button onclick="updDel(${o.id},'delivered')" class="w-full mt-2 bg-green-600 text-white py-1 rounded font-bold">تم التسليم</button>`:'');
            d.innerHTML=`<div class="flex justify-between font-bold mb-1"><span>${o.customer.name}</span><span>#${o.id.toString().slice(-4)}</span></div><div class="text-xs text-slate-500 mb-2">${o.customer.phone}<br>${o.customer.address}</div><div class="font-bold text-right">${o.finalTotal.toFixed(2)} ر.س</div>${btn}<div class="mt-2 flex gap-1"><button onclick="printInvoice(${o.id})" class="flex-1 bg-white border text-xs py-1 rounded">فاتورة</button>${o.status!=='paid'?`<button onclick="openPaymentModal(${o.id})" class="flex-1 bg-sky-100 text-sky-700 text-xs py-1 rounded">دفع</button>`:'<span class="flex-1 text-center text-xs text-green-600 font-bold py-1">مدفوع</span>'}</div>`;
            return d;
        }
        function updDel(id,s) { const o=systemOrders.find(x=>x.id===id); if(o){o.deliveryStatus=s; renderDeliveryOrders();} }
        function renderTransactions() { document.getElementById('transactions-table-body').innerHTML = systemOrders.map(o=>`<tr class="bg-white border-b hover:bg-slate-50 ${o.isCancelled?'opacity-50':''}"><td class="px-6 py-4 font-bold">#${o.id.toString().slice(-4)}</td><td class="px-6 py-4">${o.type==='delivery'?'دليفري':`طاولة ${o.table}`}</td><td class="px-6 py-4">${o.time}</td><td class="px-6 py-4 font-bold">${o.finalTotal.toFixed(2)}</td><td class="px-6 py-4">${o.isCancelled?'ملغاة':(o.status==='paid'?'مدفوعة':'معلقة')}</td><td class="px-6 py-4 text-center">${!o.isCancelled?`<button onclick="cancelOrder(${o.id})" class="text-red-500 text-xs border border-red-200 px-3 py-1 rounded">إلغاء</button>`:'-'}</td></tr>`).join(''); }
        function cancelOrder(id) { if(confirm('إلغاء؟')) { const o=systemOrders.find(x=>x.id===id); if(o){o.isCancelled=true; o.status='cancelled'; renderTransactions();} } }
        function renderReports() {
            const v = systemOrders.filter(o=>!o.isCancelled);
            document.getElementById('report-total-sales').innerText = v.reduce((s,o)=>s+o.finalTotal,0).toFixed(2)+' ر.س';
            document.getElementById('report-total-orders').innerText = v.length;
            document.getElementById('report-cancelled').innerText = systemOrders.filter(o=>o.isCancelled).length;
            let c={fish:0,shrimp:0,sides:0,drinks:0}; v.forEach(o=>o.items.forEach(i=>c[i.category]+=i.qty));
            const t = Object.values(c).reduce((a,b)=>a+b,0)||1;
            document.getElementById('category-bars').innerHTML = `<div><div class="flex justify-between text-sm font-bold"><span>أسماك</span><span>${(c.fish/t*100).toFixed(1)}%</span></div><div class="w-full bg-slate-100 h-3 rounded-full"><div class="bg-blue-500 h-3 rounded-full" style="width:${c.fish/t*100}%"></div></div></div>`;
        }
        function renderAdminTable() { document.getElementById('admin-table-body').innerHTML = menuItems.map(i=>`<tr class="bg-white border-b"><td class="px-6 py-4 font-bold">${i.name}</td><td class="px-6 py-4">${i.category}</td><td class="px-6 py-4"><input type="number" value="${i.price}" onchange="updatePrice(${i.id},this.value)" class="w-20 border rounded text-center"></td><td class="px-6 py-4"><input type="checkbox" ${i.inStock?'checked':''} onchange="toggleStock(${i.id})"></td><td class="px-6 py-4 text-center"><i class="fas fa-save text-sky-600"></i></td></tr>`).join(''); }
        function updatePrice(id,p) { const i=menuItems.find(x=>x.id===id); if(i) i.price=parseFloat(p); }
        function toggleStock(id) { const i=menuItems.find(x=>x.id===id); if(i) i.inStock=!i.inStock; }
        function openAddItemModal() { document.getElementById('new-item-name').value=''; document.getElementById('add-item-modal').classList.remove('hidden'); }
        function saveNewItem() { 
            const n=document.getElementById('new-item-name').value, p=document.getElementById('new-item-price').value;
            if(n&&p) { menuItems.push({id:Date.now(), name:n, price:parseFloat(p), category:document.getElementById('new-item-category').value, type:document.getElementById('new-item-type').value, icon:'fa-circle', color:'text-gray-500', inStock:true}); closeModal('add-item-modal'); renderAdminTable(); } 
        }
        
        // Payment & Print Utils (Condensed)
        function openPaymentModal(id){currentPayOrderId=id; const o=systemOrders.find(x=>x.id===id); if(o){document.getElementById('pay-subtotal').innerText=o.subtotal.toFixed(2); document.getElementById('pay-tax').innerText=o.tax.toFixed(2); updatePaymentTotals(); document.getElementById('payment-modal').classList.remove('hidden');}}
        function updatePaymentTotals(){const o=systemOrders.find(x=>x.id===currentPayOrderId); if(!o)return; const sub=o.subtotal+o.tax, d=sub*(parseInt(document.getElementById('pay-discount-pct').value)||0)/100, f=sub-d; document.getElementById('pay-final-total').innerText=f.toFixed(2); if(document.getElementById('split-check').checked) document.getElementById('split-amount').innerText=`(${(f/(parseInt(document.getElementById('split-count').value)||1)).toFixed(2)})`;}
        function toggleSplit() { const s=document.getElementById('split-check').checked; document.getElementById('split-count').classList.toggle('hidden',!s); document.getElementById('split-amount').classList.toggle('hidden',!s); if(s)updatePaymentTotals(); }
        function processPayment(m){const o=systemOrders.find(x=>x.id===currentPayOrderId); if(o){o.status='paid';o.finalTotal=parseFloat(document.getElementById('pay-final-total').innerText); closeModal('payment-modal'); if(!document.getElementById('system-view').classList.contains('hidden'))renderSystemOrders(); if(!document.getElementById('delivery-view').classList.contains('hidden'))renderDeliveryOrders(); printInvoice(o.id);}}
        function printKitchenTicket(id){const o=systemOrders.find(x=>x.id===id); if(!o)return; const h=o.items.map(i=>`<div>${i.qty}x ${i.name} ${i.method||''}</div>`).join(''); document.getElementById('print-area').innerHTML=`<div style="width:80mm;text-align:center"><h2>مطبخ</h2><h1>${o.table}</h1>${h}</div>`; window.print();}
        function printInvoice(id){const o=systemOrders.find(x=>x.id===id); if(!o)return; const h=o.items.map(i=>`<tr><td>${i.name}</td><td>${i.qty}</td><td>${(i.price*i.qty).toFixed(2)}</td></tr>`).join(''); document.getElementById('print-area').innerHTML=`<div style="width:80mm;text-align:center;font-family:'Cairo'"><h2>مطعم حكاية</h2><p>#${o.id.toString().slice(-4)}</p><table>${h}</table><h3>${o.finalTotal.toFixed(2)}</h3></div>`; window.print();}
        function showNotification(m,t='success'){const e=document.getElementById('notification'); document.getElementById('notif-text').innerText=m; e.classList.remove('translate-y-32'); setTimeout(()=>e.classList.add('translate-y-32'),3000);}
        async function callGemini(p){try{const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:p}]}]})});const d=await r.json();return d.candidates[0].content.parts[0].text;}catch(e){return null;}}
        async function getSmartSuggestions(){if(cart.length===0)return showNotification('فارغة','error');document.getElementById('ai-modal').classList.remove('hidden'); document.getElementById('ai-content').innerText='جاري التحليل...'; const res=await callGemini(`Suggest 2 items from ${JSON.stringify(menuItems.map(i=>i.name))} not in ${cart.map(i=>i.name)}. JSON array.`); if(res) document.getElementById('ai-content').innerText=res; }
        async function generateMarketingPost(){document.getElementById('marketing-modal').classList.remove('hidden'); document.getElementById('marketing-content').innerText='جاري التوليد...'; const res=await callGemini('Write arabic post for seafood restaurant'); if(res) document.getElementById('marketing-content').innerText=res;}
        function closeAiModal(){document.getElementById('ai-modal').classList.add('hidden');}
        function copyToClipboard(){navigator.clipboard.writeText(document.getElementById('marketing-content').innerText); showNotification('تم النسخ');}
    </script>
</body>
</html>
